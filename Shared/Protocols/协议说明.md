# 共享协议说明（单一来源）

## 通用规则
- **字节序**：小端序（Windows 默认）
- **对齐方式**：`Pack = 1`（禁止自动对齐）
- **平台**：x86
- **命名约定**：所有共享内存名称与版本号以此文档为准
- **校验原则**：
  - **有 Size 字段的结构体**：必须同时校验 `Version` 与 `Size`
  - **无 Size 字段的结构体**：校验 `Version` + 映射区大小

---

## Helper 状态通道（Status）

### 共享内存名称
- `Global\\GameHelperStatus_{pid}`
- `Local\\GameHelperStatus_{pid}`

### 结构体：HelperStatusV2
- **Version**：`3`
- **Size**：`136` 字节

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| Version | uint32 | 协议版本 |
| Size | uint32 | 结构体大小 |
| LastTickMs | uint64 | 最后心跳时间（毫秒） |
| Pid | uint32 | 目标进程 PID |
| ProcessAlive | int32 | 进程存活标记（0/1） |
| AutoTransparentEnabled | int32 | 自动透明开关 |
| FullscreenAttackTarget | int32 | 全屏攻击目标开关 |
| FullscreenAttackPatchOn | int32 | 全屏攻击补丁状态 |
| AttractMode | int32 | 吸怪模式 |
| AttractPositive | int32 | 吸怪方向 |
| SummonEnabled | int32 | 召唤开关 |
| SummonLastTick | uint64 | 召唤最后触发时间 |
| FullscreenSkillEnabled | int32 | 全屏技能开关 |
| FullscreenSkillActive | int32 | 全屏技能激活状态 |
| FullscreenSkillHotkey | uint32 | 全屏技能热键 |
| HotkeyEnabled | int32 | 热键总开关 |
| PlayerName | wchar_t[32] | 玩家名（UTF-16，`\0` 结尾） |

### 校验规则
- 读取时：`Version == 3` 且 `Size == 136` 才认为有效。
- 写入时：必须写入正确的 `Version` 与 `Size`。

---

## Helper 控制通道（Control）

### 共享内存名称
- `Global\\GameHelperControl_{pid}`
- `Local\\GameHelperControl_{pid}`

### 结构体：HelperControlV1
- **Version**：`1`
- **Size**：`28` 字节

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| Version | uint32 | 协议版本 |
| Size | uint32 | 结构体大小 |
| Pid | uint32 | 目标进程 PID |
| LastUpdateTick | uint32 | 最近更新时间（TickCount） |
| FullscreenAttack | uint8 | 全屏攻击开关 |
| FullscreenSkill | uint8 | 全屏技能开关 |
| AutoTransparent | uint8 | 自动透明开关 |
| Attract | uint8 | 吸怪开关 |
| HotkeyEnabled | uint8 | 热键总开关 |
| Reserved0 | uint8 | 保留 |
| Reserved1 | uint8 | 保留 |
| Reserved2 | uint8 | 保留 |
| SummonSequence | uint32 | 召唤序列号 |

### 校验规则
- 读取/写入时：`Version == 1` 且 `Size == 28` 才认为有效。

---

## Sync 键盘状态通道

### 共享内存名称
- `Local\\DNFSyncBox.KeyboardState.V2`

### 结构体：SharedKeyboardStateV2
- **Version**：`2`
- **Size**：`1824` 字节（仅用于映射区大小校验）

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| Version | uint32 | 协议版本 |
| Seq | uint32 | 序列号（奇数写入中、偶数写入完成） |
| Flags | uint32 | 标记位（`Paused=0x1`，`Clear=0x2`） |
| ActivePid | uint32 | 当前生效 PID |
| ProfileId | uint32 | 当前配置 ID |
| ProfileMode | uint32 | 当前模式 |
| LastTick | uint64 | 最近心跳时间 |
| KeyboardState | uint8[256] | 按键状态快照 |
| EdgeCounter | uint32[256] | 按键边沿计数 |
| TargetMask | uint8[256] | 目标键掩码 |
| BlockMask | uint8[256] | 屏蔽键掩码 |

### 校验规则
- 读取时：`Version == 2` 且映射区大小 == `1824`。
- 写入时：必须先写入 `Version`，再使用 `Seq` 进行无锁一致性更新。
