# 共享协议说明（单一来源）

## 通用规则
- **字节序**：小端序（Windows 默认）
- **对齐方式**：`Pack = 1`（禁止自动对齐）
- **平台**：x86
- **命名约定**：所有共享内存名称与版本号以此文档为准
- **校验原则**：
  - **有 Size 字段的结构体**：必须同时校验 `Version` 与 `Size`
  - **无 Size 字段的结构体**：校验 `Version` + 映射区大小

---

## Helper 状态通道（Status）

### 共享内存名称
- `Global\\GameHelperStatus_{pid}`
- `Local\\GameHelperStatus_{pid}`

### 结构体：HelperStatusV5
- **Version**：`5`
- **Size**：`152` 字节

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| Version | uint32 | 协议版本 |
| Size | uint32 | 结构体大小 |
| LastTickMs | uint64 | 最后心跳时间（毫秒） |
| Pid | uint32 | 目标进程 PID |
| ProcessAlive | int32 | 进程存活标记（0/1） |
| AutoTransparentEnabled | int32 | 自动透明开关 |
| FullscreenAttackTarget | int32 | 全屏攻击目标开关 |
| FullscreenAttackPatchOn | int32 | 全屏攻击补丁状态 |
| AttractMode | int32 | 吸怪模式 |
| AttractPositive | int32 | 吸怪方向 |
| GatherItemsEnabled | int32 | 聚物开关 |
| DamageEnabled | int32 | 动态倍攻开关 |
| DamageMultiplier | int32 | 动态倍攻倍率（1~1000） |
| InvincibleEnabled | int32 | 怪物零伤开关 |
| SummonEnabled | int32 | 召唤开关 |
| SummonLastTick | uint64 | 召唤最后触发时间 |
| FullscreenSkillEnabled | int32 | 全屏技能开关 |
| FullscreenSkillActive | int32 | 全屏技能激活状态 |
| FullscreenSkillHotkey | uint32 | 全屏技能热键 |
| HotkeyEnabled | int32 | 热键总开关 |
| PlayerName | wchar_t[32] | 玩家名（UTF-16，`\0` 结尾） |

### 校验规则
- 读取时：`Version == 5` 且 `Size == 152` 才认为有效。
- 写入时：必须写入正确的 `Version` 与 `Size`。

---

## Helper 控制通道（Control）

### 共享内存名称
- `Global\\GameHelperControl_{pid}`
- `Local\\GameHelperControl_{pid}`

### 结构体：HelperControlV4
- **Version**：`4`
- **Size**：`56` 字节

> V4 在 V3 的基础上新增“动态倍攻/怪物零伤”动作与字段。

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| Version | uint32 | 协议版本 |
| Size | uint32 | 结构体大小 |
| Pid | uint32 | 目标进程 PID |
| LastUpdateTick | uint32 | 最近更新时间（TickCount） |
| FullscreenAttack | uint8 | 全屏攻击覆盖模式（Follow/ForceOff/ForceOn） |
| FullscreenSkill | uint8 | 全屏技能覆盖模式（Follow/ForceOff/ForceOn） |
| AutoTransparent | uint8 | 自动透明覆盖模式（Follow/ForceOff/ForceOn） |
| Attract | uint8 | 吸怪覆盖模式（Follow/ForceOff/ForceOn） |
| HotkeyEnabled | uint8 | 热键覆盖模式（Follow/ForceOff/ForceOn） |
| Reserved0 | uint8 | 保留 |
| Reserved1 | uint8 | 保留 |
| Reserved2 | uint8 | 保留 |
| SummonSequence | uint32 | 召唤序列号（递增触发一次召唤） |
| ActionSequence | uint32 | 动作序列号（变化时才处理动作） |
| ActionMask | uint32 | 动作掩码（位标记以下字段是否有效） |
| DesiredFullscreenAttack | uint8 | 目标：全屏攻击开关（0/1） |
| DesiredFullscreenSkill | uint8 | 目标：全屏技能激活（0/1） |
| DesiredAutoTransparent | uint8 | 目标：自动透明开关（0/1） |
| DesiredAttractEnabled | uint8 | 目标：吸怪开关（0/1） |
| DesiredAttractMode | uint8 | 目标：吸怪档位（1~4，对应配置1~4；0 表示关闭） |
| DesiredAttractPositive | uint8 | 目标：吸怪方向（1=正向，0=负向） |
| DesiredHotkeyEnabled | uint8 | 目标：热键总开关（0/1） |
| DesiredGatherItemsEnabled | uint8 | 目标：聚物开关（0/1） |
| DesiredDamageMultiplier | uint32 | 目标：动态倍攻倍率（1~1000） |
| DesiredDamageEnabled | uint8 | 目标：动态倍攻开关（0/1） |
| DesiredInvincibleEnabled | uint8 | 目标：怪物零伤开关（0/1） |
| Reserved3~Reserved8 | uint8[6] | 保留 |

#### ActionMask 取值（位标记）
- `0x01`：DesiredFullscreenAttack
- `0x02`：DesiredFullscreenSkill
- `0x04`：DesiredAutoTransparent
- `0x08`：DesiredAttractEnabled
- `0x10`：DesiredAttractMode
- `0x20`：DesiredAttractPositive
- `0x40`：DesiredHotkeyEnabled
- `0x80`：DesiredGatherItemsEnabled
- `0x100`：DesiredDamageEnabled
- `0x200`：DesiredDamageMultiplier
- `0x400`：DesiredInvincibleEnabled

### 校验规则
- 读取/写入时：`Version == 4` 且 `Size == 56` 才认为有效。
- 动作处理：仅当 `ActionSequence` 发生变化时才处理 `ActionMask` 对应动作。

---

## Sync 键盘状态通道

### 共享内存名称
- `Local\\DNFSyncBox.KeyboardState.V2`

### 结构体：SharedKeyboardStateV2
- **Version**：`2`
- **Size**：`1824` 字节

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| Version | uint32 | 协议版本 |
| Seq | uint32 | 快照序号（奇数写入，偶数完成） |
| Flags | uint32 | 标志位（Paused/Clear） |
| ActivePid | uint32 | 当前主控 PID |
| ProfileId | uint32 | 方案 ID |
| ProfileMode | uint32 | 方案模式 |
| LastTick | uint64 | 心跳时间戳（TickCount64） |
| KeyboardState | byte[256] | 键盘状态（0x80 按下，低位为切换态） |
| EdgeCounter | uint32[256] | 边沿计数（按下自增） |
| TargetMask | byte[256] | 目标键掩码（1=同步输出） |
| BlockMask | byte[256] | 拦截键掩码（1=强制抬起） |

### 校验规则
- 读取时：`Version == 2`。
- 读取时：映射区大小需 ≥ `1824`。
- 写入时：先将 `Seq` 置为奇数写入，写完再置为偶数。
