
---

# âš”ï¸ game-all å®Œæ•´å·¥ç¨‹åˆå¹¶æ–¹æ¡ˆ

## ğŸ¯ é¡¹ç›®ç›®æ ‡

æ„å»ºä¸€ä¸ªåä¸º `game-all` çš„è§£å†³æ–¹æ¡ˆï¼ŒåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

1. **Payload (game-payload.dll)** : x86 DLLï¼Œåˆå¹¶äº†æ¸¸æˆè¾…åŠ© (Helper) å’ŒåŒæ­¥å™¨ (Sync) çš„æ ¸å¿ƒé€»è¾‘ã€‚
2. **Injector (game-injector.exe)** : x86 æ§åˆ¶å°ç¨‹åºï¼Œé‡‡ç”¨ APC æŠ€æœ¯å°† DLL æ³¨å…¥æ¸¸æˆã€‚
3. **MasterGUI (game-master.exe)** : C# WPF ç¨‹åºï¼Œæä¾›åŒåŠŸèƒ½æ§åˆ¶é¢æ¿ã€‚

---

## âœ… å·¥ç¨‹è½åœ°å†³ç­–ï¼ˆå·²ç¡®è®¤ï¼‰

1. **åè®®å•ä¸€æ¥æºæ–¹å¼**ï¼šä¸å¼•å…¥è‡ªåŠ¨ç”Ÿæˆä½“ç³»ï¼Œé‡‡ç”¨ **Shared/Protocols/** ä½œä¸ºåè®®â€œå•ä¸€æ¥æºâ€ã€‚
   - ç›®æ ‡ï¼šå‡å°‘ C++/C# ç»“æ„ä½“ä¸ä¸€è‡´é£é™©ï¼Œç¡®ä¿ç‰ˆæœ¬ä¸€è‡´æ€§ã€‚
   - è¦æ±‚ï¼šæ‰€æœ‰å…±äº«å†…å­˜ç»“æ„ä½“å®šä¹‰ä¸ç‰ˆæœ¬å·å¿…é¡»é›†ä¸­ç»´æŠ¤åœ¨ `Shared/Protocols/`ã€‚
2. **MasterGUI ä¸ Injector å…³ç³»**ï¼šé‡‡ç”¨**åŠé›†æˆ**æ¨¡å¼ã€‚
   - MasterGUI ä»…æä¾›â€œå¿«æ·å…¥å£ï¼ˆæ‰“å¼€æ³¨å…¥å™¨ç›®å½•/æŒ‰é’®ï¼‰â€ä¸â€œçŠ¶æ€æ£€æµ‹æç¤ºâ€ã€‚
   - MasterGUI **ä¸ç›´æ¥è´Ÿè´£**å¯åŠ¨/åœæ­¢æ³¨å…¥å™¨é€»è¾‘ï¼Œé™ä½æƒé™ä¸è€¦åˆé£é™©ã€‚
3. **GUI ç›®æ ‡æ¡†æ¶ç»Ÿä¸€**ï¼šæ‰€æœ‰ GUI é¡¹ç›®ç»Ÿä¸€ä¸º **net8.0-windows**ã€‚
   - ç›®æ ‡ï¼šå‡å°‘è¿è¡Œæ—¶å·®å¼‚ä¸å‘å¸ƒå¤æ‚åº¦ã€‚
   - è¦æ±‚ï¼šç»Ÿä¸€ `TargetFramework`ï¼Œå¹¶åŒæ­¥æ›´æ–°ç›¸å…³ä¾èµ–ã€‚

---

## ç¬¬ä¸€é˜¶æ®µï¼šç›®å½•ç»“æ„é‡ç»„ (æ‰‹åŠ¨æ“ä½œ)

è¯·åœ¨ç£ç›˜ä¸Šåˆ›å»ºä¸€ä¸ªåä¸º `game-all` çš„æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸¥æ ¼æŒ‰ä»¥ä¸‹ç»“æ„ç»„ç»‡æ–‡ä»¶ã€‚

> **âš ï¸ æ³¨æ„** ï¼šæ ‡æœ‰ `[æ¬è¿]` çš„æ–‡ä»¶éœ€è¦æ‚¨ä»åŸé¡¹ç›®ä¸­å¤åˆ¶è¿‡æ¥ã€‚

**Plaintext**

```
game-all/
â”œâ”€â”€ ğŸ“ Shared/
â”‚   â””â”€â”€ ğŸ“ Protocols/                 <-- [æ–°å»º] åè®®å•ä¸€æ¥æºï¼ˆC++/C# å¯¹é½ï¼‰
â”œâ”€â”€ ğŸ“ Payload/                       <-- [C++ DLL é¡¹ç›®] è¾“å‡º: game-payload.dll
â”‚   â”œâ”€â”€ ğŸ“ lib/                       <-- ç¬¬ä¸‰æ–¹åº“ç›®å½•
â”‚   â”‚   â””â”€â”€ ğŸ“ MinHook/               <-- MinHook åº“ (å¿…é¡»æ”¾è¿™é‡Œ)
â”‚   â”‚       â”œâ”€â”€ MinHook.h             <-- [æ¬è¿]
â”‚   â”‚       â””â”€â”€ MinHook.x86.lib       <-- [æ¬è¿]
â”‚   â”œâ”€â”€ ğŸ“ modules/
â”‚   â”‚   â”œâ”€â”€ ğŸ“ helper/                <-- [æ¬è¿] åŸ version-inject ç›®å½•ä¸‹çš„ .h/.cpp
â”‚   â”‚   â”‚   â””â”€â”€ HelperMod.cpp         <-- [é‡å‘½å] ç”± version_proxy.cpp æ”¹åè€Œæ¥
â”‚   â”‚   â””â”€â”€ ğŸ“ sync/                  <-- [æ¬è¿] åŸ dnfinput ç›®å½•ä¸‹çš„ .h/.cpp
â”‚   â”‚       â””â”€â”€ SyncMod.cpp           <-- [é‡å‘½å] ç”± dnfinput.cpp æ”¹åè€Œæ¥
â”‚   â”œâ”€â”€ dllmain.cpp                   <-- [æ–°å»º] ç»Ÿä¸€å…¥å£ (ä»£ç è§ä¸‹æ–‡)
â”‚   â”œâ”€â”€ pch.h                         <-- [æ–°å»º] é¢„ç¼–è¯‘å¤´ (ä»£ç è§ä¸‹æ–‡)
â”‚   â””â”€â”€ pch.cpp                       <-- [æ–°å»º] é¢„ç¼–è¯‘æºæ–‡ä»¶
â”‚
â”œâ”€â”€ ğŸ“ Injector/                      <-- [C++ Console é¡¹ç›®] è¾“å‡º: game-injector.exe
â”‚   â””â”€â”€ main.cpp                      <-- [æ–°å»º] APC æ³¨å…¥å™¨æºç  (ä»£ç è§ä¸‹æ–‡)
â”‚
â””â”€â”€ ğŸ“ GUI/                           <-- [C# WPF é¡¹ç›®] è¾“å‡º: game-master.exe
    â”œâ”€â”€ App.xaml
    â”œâ”€â”€ MainWindow.xaml               <-- [ä¿®æ”¹] åŒ…å« TabControl çš„ä¸»ç•Œé¢
    â”œâ”€â”€ ğŸ“ Modules/
    â”‚   â”œâ”€â”€ ğŸ“ Helper/                <-- [æ¬è¿] åŸ GameHelperGUI ä»£ç 
    â”‚   â””â”€â”€ ğŸ“ Sync/                  <-- [æ¬è¿] åŸ DNFSyncBox ä»£ç 
    â””â”€â”€ ...
```

---

## åè®®å•ä¸€æ¥æºï¼ˆShared/Protocolsï¼‰

**ç›®æ ‡**ï¼šç»Ÿä¸€ C++ ä¸ C# çš„å…±äº«å†…å­˜ç»“æ„å®šä¹‰ä¸ç‰ˆæœ¬å·ï¼Œé™ä½ç»“æ„ä½“é”™ä½é£é™©ã€‚

**åšæ³•**ï¼š

1. åœ¨ `Shared/Protocols/` ä¸­ç»´æŠ¤åè®®å®šä¹‰æ–‡æ¡£ï¼ˆå»ºè®®æŒ‰æ¨¡å—æ‹†åˆ†ï¼‰ï¼š
   - `HelperStatusV2`ã€`HelperControlV1`
   - `SharedKeyboardStateV2`
2. **å¼ºåˆ¶ç‰ˆæœ¬ä¸å¤§å°æ ¡éªŒ**ï¼š
   - GUI ç«¯ï¼šè¯»å–/å†™å…¥æ—¶æ ¡éªŒ `Version` ä¸ `Size`ã€‚
   - Payload ç«¯ï¼šå†™å…¥/è¯»å–å…±äº«å†…å­˜æ—¶ï¼ŒåŒæ ·è¿›è¡Œ `Version` ä¸ `Size` æ ¡éªŒã€‚
3. ä»»ä½•åè®®å˜æ›´å¿…é¡»å…ˆæ›´æ–° `Shared/Protocols/`ï¼Œå†æ”¹ä»£ç ã€‚

**ç¤ºä¾‹**ï¼ˆé€šä¿—è¯´æ˜ï¼‰ï¼š

> â€œç»“æ„ä½“å®šä¹‰å°±åƒä¸€å¼ è¡¨æ ¼ï¼ŒC++ å’Œ C# éƒ½å¿…é¡»ç”¨åŒä¸€ä»½æ¨¡æ¿ï¼Œå¦åˆ™å­—æ®µä¼šé”™ä½ã€‚â€

---

## åè®®å¼•ç”¨ï¼ˆå¿…è¯»ï¼‰

**å”¯ä¸€æƒå¨**ï¼š`Shared/Protocols/åè®®è¯´æ˜.md`

**è¦æ±‚**ï¼š

- åè®®å­—æ®µã€ç‰ˆæœ¬å·ã€å¤§å°æ ¡éªŒå¿…é¡»ä»¥è¯¥æ–‡ä»¶ä¸ºå‡†ã€‚
- ä»»ä½•ä»£ç å˜æ›´å‰ï¼Œå…ˆæ›´æ–°åè®®è¯´æ˜ï¼Œå†åŒæ­¥ C++ ä¸ C# å®ç°ã€‚
- ä»£ç å®¡æŸ¥æ—¶ä»¥åè®®è¯´æ˜ä¸ºå¯¹ç…§ï¼Œç¡®ä¿å­—æ®µé¡ºåºä¸ç±»å‹ä¸€è‡´ã€‚

---

## ç¬¬äºŒé˜¶æ®µï¼šPayload (DLL) ä»£ç æ”¹é€ 

### 1. é…ç½®é¢„ç¼–è¯‘å¤´ (`Payload/pch.h`)

åœ¨ VS ä¸­è®¾ç½®é¡¹ç›®ä½¿ç”¨é¢„ç¼–è¯‘å¤´ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

**C++**

```
#pragma once
#define WIN32_LEAN_AND_MEAN
#include <windows.h>
#include <vector>
#include <string>
#include <iostream>

// å¼•å…¥ MinHook (è·¯å¾„å·²åœ¨ç¬¬ä¸€é˜¶æ®µè§„åˆ’å¥½)
#include "../lib/MinHook/MinHook.h"
```

### 2. æ”¹é€  Helper æ¨¡å— (`HelperMod.cpp`)

 **æ“ä½œå¯¹è±¡** ï¼š`Payload/modules/helper/HelperMod.cpp` (åŸ `version_proxy.cpp`)

* **ä¿®æ”¹ç‚¹ 1** ï¼šåˆ é™¤ `#include "version_exports.h"` åŠæ‰€æœ‰ `#pragma comment(linker, ...)`ã€‚
* **ä¿®æ”¹ç‚¹ 2** ï¼šåœ¨æ–‡ä»¶é¦–å°¾æ·»åŠ  `namespace Helper { ... }`ã€‚
* **ä¿®æ”¹ç‚¹ 3** ï¼šåˆ é™¤åŸæœ‰çš„ `DllMain`ï¼Œæ”¹ä¸º `Start` å‡½æ•°ã€‚

**C++**

```
// åœ¨ namespace Helper { å†…éƒ¨çš„æœ«å°¾ ...

    // [æ–°å¢] å¯åŠ¨æ¥å£
    void Start() {
        // æ¨¡æ‹ŸåŸ DllMain çš„åˆå§‹åŒ–é€»è¾‘
        // æ³¨æ„ï¼šg_self_module å˜é‡éœ€è¦åœ¨æœ¬æ–‡ä»¶é¡¶éƒ¨å£°æ˜è¿‡
        g_self_module = GetModuleHandleA(NULL); 
      
        // å¯åŠ¨å·¥ä½œçº¿ç¨‹ (ä¿ç•™åŸé€»è¾‘)
        HANDLE thread = CreateThread(NULL, 0, WorkerThread, NULL, 0, NULL);
        if (thread) CloseHandle(thread);
    }

    void Stop() {
        // æ¸…ç†é€»è¾‘
    }
} // namespace Helper ç»“æŸ
```

### 3. æ”¹é€  Sync æ¨¡å— (`SyncMod.cpp`)

 **æ“ä½œå¯¹è±¡** ï¼š`Payload/modules/sync/SyncMod.cpp` (åŸ `dnfinput.cpp`)

* åŒæ ·åŒ…è£¹ `namespace Sync { ... }`ã€‚
* åˆ é™¤ `DllMain`ï¼Œå°†åˆå§‹åŒ–é€»è¾‘å°è£…è¿› `Sync::Start()`ã€‚

### 4. ç¼–å†™ç»Ÿä¸€å…¥å£ (`Payload/dllmain.cpp`)

**C++**

```
#include "pch.h"
#include <atomic>

// å£°æ˜å­æ¨¡å—æ¥å£
namespace Helper { void Start(); void Stop(); }
namespace Sync   { void Start(); void Stop(); }

std::atomic<bool> g_IsInitialized(false);

DWORD WINAPI UnifiedInitThread(LPVOID lpParam) {
    // 1. åˆå§‹åŒ– MinHook (åªéœ€ä¸€æ¬¡)
    if (MH_Initialize() != MH_OK) {
        OutputDebugStringA("[game-all] MinHook init failed!");
    }

    // 2. å¯åŠ¨åŒæ­¥æ¨¡å— (å»ºè®®å…ˆå¯åŠ¨ Input Hook)
    Sync::Start();

    // 3. å¯åŠ¨è¾…åŠ©æ¨¡å—
    Helper::Start();

    return 0;
}

BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved) {
    switch (ul_reason_for_call) {
    case DLL_PROCESS_ATTACH:
        // åŸå­é”é˜²æ­¢ APC é‡å¤è§¦å‘
        bool expected = false;
        if (g_IsInitialized.compare_exchange_strong(expected, true)) {
            DisableThreadLibraryCalls(hModule);
            // å¼€å¯æ–°çº¿ç¨‹è¿›è¡Œåˆå§‹åŒ–ï¼Œé¿å… Loader Lock æ­»é”
            CreateThread(NULL, 0, UnifiedInitThread, NULL, 0, NULL);
        }
        break;
    }
    return TRUE;
}
```

---

## ç¬¬ä¸‰é˜¶æ®µï¼šInjector (æ³¨å…¥å™¨) ä»£ç å®ç°

 **æ“ä½œå¯¹è±¡** ï¼š`Injector/main.cpp`

è¿™æ˜¯åŸºäº `APCinjecter.cpp` ä¼˜åŒ–åçš„ç‰ˆæœ¬ï¼Œå¢åŠ äº†ææƒå’Œç­‰å¾…åŠŸèƒ½ã€‚

**C++**

```
#include <windows.h>
#include <tlhelp32.h>
#include <vector>
#include <string>
#include <iostream>
#include <thread>
#include <chrono>

// æ—¥å¿—è¾…åŠ©
void Log(const std::wstring& msg) { std::wcout << L"[Injector] " << msg << std::endl; }

// 1. ææƒ (SeDebugPrivilege)
bool EnableDebugPrivilege() {
    HANDLE hToken;
    TOKEN_PRIVILEGES tp;
    LUID luid;
    if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &hToken)) return false;
    if (!LookupPrivilegeValue(NULL, SE_DEBUG_NAME, &luid)) { CloseHandle(hToken); return false; }
    tp.PrivilegeCount = 1;
    tp.Privileges[0].Luid = luid;
    tp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
    if (!AdjustTokenPrivileges(hToken, FALSE, &tp, sizeof(TOKEN_PRIVILEGES), NULL, NULL)) { CloseHandle(hToken); return false; }
    CloseHandle(hToken);
    return (GetLastError() == ERROR_SUCCESS);
}

// 2. æŸ¥æ‰¾ PID
DWORD FindProcessId(const std::wstring& processName) {
    PROCESSENTRY32W pe32 = { sizeof(PROCESSENTRY32W) };
    HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
    if (hSnapshot == INVALID_HANDLE_VALUE) return 0;
    DWORD pid = 0;
    if (Process32FirstW(hSnapshot, &pe32)) {
        do {
            if (processName == pe32.szExeFile) { pid = pe32.th32ProcessID; break; }
        } while (Process32NextW(hSnapshot, &pe32));
    }
    CloseHandle(hSnapshot);
    return pid;
}

// 3. APC æ³¨å…¥
bool PerformApcInjection(DWORD pid, const std::wstring& dllPath) {
    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);
    if (!hProcess) return false;

    size_t size = (dllPath.length() + 1) * sizeof(wchar_t);
    LPVOID remoteMem = VirtualAllocEx(hProcess, NULL, size, MEM_COMMIT, PAGE_READWRITE);
    if (!remoteMem) { CloseHandle(hProcess); return false; }

    if (!WriteProcessMemory(hProcess, remoteMem, dllPath.c_str(), size, NULL)) {
        VirtualFreeEx(hProcess, remoteMem, 0, MEM_RELEASE);
        CloseHandle(hProcess);
        return false;
    }

    // âš ï¸ å…³é”®ï¼šå¿…é¡»ç¼–è¯‘ä¸º x86ï¼Œå¦åˆ™ kernel32 åœ°å€ä¸åŒ¹é…
    PAPCFUNC pLoadLibrary = (PAPCFUNC)GetProcAddress(GetModuleHandleW(L"kernel32.dll"), "LoadLibraryW");
  
    HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, 0);
    THREADENTRY32 te32 = { sizeof(THREADENTRY32) };
    int queued = 0;

    if (Thread32First(hSnapshot, &te32)) {
        do {
            if (te32.th32OwnerProcessID == pid) {
                HANDLE hThread = OpenThread(THREAD_SET_CONTEXT, FALSE, te32.th32ThreadID);
                if (hThread) {
                    if (QueueUserAPC(pLoadLibrary, hThread, (ULONG_PTR)remoteMem)) queued++;
                    CloseHandle(hThread);
                }
            }
        } while (Thread32Next(hSnapshot, &te32));
    }
    CloseHandle(hSnapshot);
    CloseHandle(hProcess);
    return queued > 0;
}

int main() {
    SetConsoleTitleW(L"game-all Injector");
    if (!EnableDebugPrivilege()) Log(L"Warning: Failed to enable Debug Privilege.");

    wchar_t path[MAX_PATH];
    GetCurrentDirectoryW(MAX_PATH, path);
    std::wstring dllPath = std::wstring(path) + L"\\game-payload.dll"; // ç›®æ ‡ DLL åç§°

    Log(L"Waiting for DNF.exe...");
    DWORD pid = 0;
    while ((pid = FindProcessId(L"DNF.exe")) == 0) {
        std::this_thread::sleep_for(std::chrono::milliseconds(1000));
    }

    Log(L"Found PID: " + std::to_wstring(pid));
    std::this_thread::sleep_for(std::chrono::milliseconds(2000)); // ç­‰å¾…åˆå§‹åŒ–

    if (PerformApcInjection(pid, dllPath)) Log(L"Injection Success!");
    else Log(L"Injection Failed.");

    std::this_thread::sleep_for(std::chrono::seconds(3));
    return 0;
}
```

---

### æ³¨å…¥ç»“æœåˆ¤å®šï¼ˆå½“å‰å®æ–½ï¼‰

ä¸ºæé«˜â€œæ¨¡å—éšè—â€åœºæ™¯çš„ç¨³å®šæ€§ï¼Œæ³¨å…¥ç»“æœé‡‡ç”¨ **æˆåŠŸæ–‡ä»¶ä¸ºä¸»ã€å…±äº«å†…å­˜å¿ƒè·³å…œåº•**ï¼š

1. **æˆåŠŸæ–‡ä»¶ï¼ˆä¸»åˆ¤å®šï¼‰**  
   - æ–‡ä»¶åï¼š`successfile_%dll.name%_%pid%.txt`  
   - é»˜è®¤ç›®å½•ï¼š**DLL æ‰€åœ¨ç›®å½•ä¸‹çš„ `logs` å­ç›®å½•**ï¼ˆå¯é€šè¿‡ `injector.ini` çš„ `output_dir` è¦†ç›–ï¼‰
   - åˆ¤å®šæ–¹å¼ï¼šè®°å½•æ³¨å…¥å‰åŸºçº¿æ—¶é—´ï¼Œæ³¨å…¥åç­‰å¾…æ–‡ä»¶**æ–°å»ºæˆ–æ›´æ–°æ—¶é—´å˜åŒ–**ã€‚

2. **å…±äº«å†…å­˜å¿ƒè·³ï¼ˆå…œåº•ï¼‰**  
   - è¯»å– `GameHelperStatus_{pid}`ï¼ˆGlobal/Localï¼‰  
   - æ ¡éªŒ `Version=3` ä¸” `Size=136`  
   - `LastTickMs` è·å½“å‰æ—¶é—´ä¸è¶…è¿‡é˜ˆå€¼åˆ™åˆ¤å®šæˆåŠŸ

---

### Injector é…ç½®ï¼ˆinjector.iniï¼‰

æ³¨å…¥å™¨è¿è¡Œæ—¶è¯»å–åŒç›®å½•ä¸‹ `injector.ini`ï¼Œä¸»è¦é…ç½®é¡¹å¦‚ä¸‹ï¼š  
**æ¨¡æ¿æ–‡ä»¶**ï¼š`Injector/injector.ini`ï¼ˆæ„å»ºåè¯·å¤åˆ¶åˆ°æ³¨å…¥å™¨è¾“å‡ºç›®å½•ï¼‰ã€‚

> è¯´æ˜ï¼šå½“ `watch_mode=true` æ—¶ï¼Œæ³¨å…¥å™¨ä¼š**å¸¸é©»ç›‘å¬**ç›®æ ‡è¿›ç¨‹åˆ—è¡¨ï¼›  
> è‹¥åœ¨ `idle_exit_seconds` æ—¶é—´å†…**æ²¡æœ‰å‡ºç°æ–°çš„ç›®æ ‡è¿›ç¨‹**ï¼Œæ³¨å…¥å™¨å°†è‡ªåŠ¨é€€å‡ºã€‚

### æ—¥å¿—è¾“å‡ºè§„èŒƒï¼ˆç»Ÿä¸€ ./logsï¼‰

- **MasterGUI**ï¼š`game-master.exe` åŒçº§ `./logs/mastergui_debug.log`ï¼ˆDebugï¼‰
- **Injector**ï¼š`game-injector.exe` åŒçº§ `./logs/injector_debug.log`ï¼ˆDebugï¼‰
- **Payload**ï¼š`game-payload.dll` åŒçº§ `./logs/payload_debug.log`ï¼ˆDebugï¼‰
- **Helper**ï¼š`game-payload.dll` åŒçº§ `./logs/game_helper.jsonl`
- **Sync GUI**ï¼š`game-master.exe` åŒçº§ `./logs/latest.log`
- **æˆåŠŸæ–‡ä»¶**ï¼šé»˜è®¤ `DLL\\logs\\successfile_<dll>_<pid>.txt`

| é”® | è¯´æ˜ | é»˜è®¤å€¼ |
| --- | --- | --- |
| process_name | ç›®æ ‡è¿›ç¨‹åï¼ˆè‡ªåŠ¨è¡¥ `.exe`ï¼‰ | `DNF.exe` |
| dll_path | æ³¨å…¥ DLL è·¯å¾„ï¼ˆå¯ç›¸å¯¹ï¼‰ | `..\\payload\\game-payload.dll` |
| output_dir | æˆåŠŸæ–‡ä»¶ç›®å½•ï¼ˆç©ºåˆ™ä½¿ç”¨ DLL\\logs ç›®å½•ï¼‰ | ç©º |
| scan_interval_ms | æ‰«æè¿›ç¨‹é—´éš” | `1000` |
| inject_delay_ms | å‘ç°è¿›ç¨‹åçš„æ³¨å…¥å»¶è¿Ÿ | `2000` |
| max_retries | é‡è¯•æ¬¡æ•° | `3` |
| retry_interval_ms | é‡è¯•é—´éš” | `1000` |
| success_timeout_ms | æˆåŠŸæ–‡ä»¶åˆ¤å®šè¶…æ—¶ | `6000` |
| success_interval_ms | æˆåŠŸæ–‡ä»¶è½®è¯¢é—´éš” | `200` |
| heartbeat_timeout_ms | å¿ƒè·³å…œåº•è¶…æ—¶ | `6000` |
| heartbeat_interval_ms | å¿ƒè·³è½®è¯¢é—´éš” | `200` |
| watch_mode | æ˜¯å¦å¸¸é©»ç›‘å¬æ–°è¿›ç¨‹ | `true` |
| idle_exit_seconds | æ— æ–°ç›®æ ‡è¿›ç¨‹å‡ºç°åè‡ªåŠ¨é€€å‡ºï¼ˆç§’ï¼Œ0 ä¸é€€å‡ºï¼‰ | `600` |

---

## ç¬¬å››é˜¶æ®µï¼šVisual Studio å…³é”®é…ç½®æ£€æŸ¥

ä¸ºä¿è¯ç¼–è¯‘é€šè¿‡ä¸”è¿è¡Œæ­£å¸¸ï¼Œè¯·å¯¹ `Payload` å’Œ `Injector` é¡¹ç›®æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

| **é¡¹ç›®**     | **å±æ€§é¡µè·¯å¾„** | **è®¾ç½®é¡¹** | **å€¼**                   | **è¯´æ˜**         |
| ------------------ | -------------------- | ---------------- | ------------------------------ | ---------------------- |
| **Payload**  | C/C++ -> å¸¸è§„        | é™„åŠ åŒ…å«ç›®å½•     | `$(ProjectDir)lib\MinHook`   | è®©ä»£ç èƒ½æ‰¾åˆ° MinHook.h |
| **Payload**  | é“¾æ¥å™¨ -> å¸¸è§„       | é™„åŠ åº“ç›®å½•       | `$(ProjectDir)lib\MinHook`   | è®©é“¾æ¥å™¨èƒ½æ‰¾åˆ° .lib    |
| **Payload**  | é“¾æ¥å™¨ -> è¾“å…¥       | é™„åŠ ä¾èµ–é¡¹       | `MinHook.x86.lib`            | é“¾æ¥ MinHook           |
| **Both**     | é¡¶æ å·¥å…·æ¡           | è§£å†³æ–¹æ¡ˆå¹³å°     | **x86**                  | å¿…é¡»æ˜¯ 32 ä½           |
| **Both**     | å±æ€§ -> å¸¸è§„         | å­—ç¬¦é›†           | **ä½¿ç”¨ Unicode å­—ç¬¦é›†**  | æ”¯æŒä¸­æ–‡è·¯å¾„           |
| **Both**     | C/C++ -> ä»£ç ç”Ÿæˆ    | è¿è¡Œåº“           | **å¤šçº¿ç¨‹ (/MT)**         | é™æ€é“¾æ¥ï¼Œé¿å…ç¼ºå°‘ DLL |
| **Injector** | é“¾æ¥å™¨ -> æ¸…å•æ–‡ä»¶   | UAC æ‰§è¡Œçº§åˆ«     | **requireAdministrator** | è‡ªåŠ¨è¯·æ±‚ç®¡ç†å‘˜æƒé™     |

---

## æ„å»ºæµç¨‹ï¼ˆå»ºè®®æ‰§è¡Œé¡ºåºï¼‰

1. **è®¾ç½®å¹³å°**ï¼šè§£å†³æ–¹æ¡ˆå¹³å°ç»Ÿä¸€ä¸º `x86`ã€‚
2. **æ„å»º Payload**ï¼šç”Ÿæˆ `game-payload.dll`ã€‚
3. **æ„å»º Injector**ï¼šç”Ÿæˆ `game-injector.exe`ã€‚
4. **æ„å»º MasterGUI**ï¼šç›®æ ‡æ¡†æ¶ç»Ÿä¸€ `net8.0-windows`ã€‚
5. **è¾“å‡ºæ£€æŸ¥**ï¼šç¡®è®¤ä¸‰ç»„ä»¶æ–‡ä»¶åä¸ç›®å½•ä¸€è‡´ã€‚

---

## æ„å»ºå‰ç½®æ¡ä»¶

1. **å·¥å…·é“¾**ï¼šVisual Studio 2022ï¼ˆv143ï¼‰ä¸ C++ å·¥ä½œè´Ÿè½½å·²å®‰è£…ã€‚
2. **å¹³å°**ï¼šè§£å†³æ–¹æ¡ˆå¹³å°é€‰æ‹© `x86`ã€‚
3. **MinHook ä¾èµ–**ï¼ˆPayloadï¼‰ï¼š
   - `Payload/lib/minhook/include/MinHook.h`
   - `Payload/lib/minhook/lib/libMinHook.x86.lib`
   - è¯´æ˜ï¼š`Payload/Payload.vcxproj` å·²é…ç½® `include` ä¸ `lib` æœç´¢è·¯å¾„ï¼Œéœ€æŒ‰ä¸Šè¿°ç›®å½•æ”¾ç½®æ–‡ä»¶ã€‚
4. **.NET è¿è¡Œæ—¶**ï¼šç›®æ ‡æ¡†æ¶ `net8.0-windows` å·²å®‰è£…ã€‚

---

## å¦‚ä½•ç”Ÿæˆ MinHook åº“

1. æ‰“å¼€è§£å†³æ–¹æ¡ˆï¼š`Payload/lib/minhook/build/VC17/MinHookVC17.sln`
2. é€‰æ‹©å¹³å°ï¼š`Win32`ï¼Œé…ç½®ï¼š`Release`
3. åœ¨è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨ä¸­é€‰ä¸­ **libMinHook** é¡¹ç›®å¹¶æ‰§è¡Œæ„å»º
4. äº§ç‰©è·¯å¾„ï¼ˆç¤ºä¾‹ï¼‰ï¼š
   - `Payload/lib/minhook/build/VC17/lib/Release/libMinHook.x86.lib`
5. ç¡®è®¤å¤´æ–‡ä»¶å­˜åœ¨ï¼š
   - `Payload/lib/minhook/include/MinHook.h`

**æç¤º**ï¼š

- `Payload/Payload.vcxproj` å·²é…ç½® `include` ä¸ `build` è·¯å¾„å›é€€ï¼Œç¡®ä¿èƒ½æ‰¾åˆ°å¤´æ–‡ä»¶ä¸åº“ã€‚
- è‹¥åº“åä¸åŒï¼Œè¯·åŒæ­¥æ›´æ–° `Payload/Payload.vcxproj` çš„ `AdditionalDependencies`ã€‚

---

## å¸¸è§ç¼–è¯‘é”™è¯¯æ’æŸ¥

1. **MinHook æ‰¾ä¸åˆ°å¤´æ–‡ä»¶æˆ–åº“**
   - ç°è±¡ï¼š`MinHook.h` æˆ– `libMinHook.x86.lib` æ‰¾ä¸åˆ°ã€‚
   - å¤„ç†ï¼šç¡®è®¤ä»¥ä¸‹è·¯å¾„å­˜åœ¨æ–‡ä»¶ï¼š
     - `Payload/lib/minhook/include/MinHook.h`
     - `Payload/lib/minhook/build/VC17/lib/Release/libMinHook.x86.lib`
2. **å¹³å°ä¸åŒ¹é…ï¼ˆx64 / Any CPUï¼‰**
   - ç°è±¡ï¼šé“¾æ¥å¤±è´¥æˆ–è¿è¡Œæ—¶å´©æºƒã€‚
   - å¤„ç†ï¼šè§£å†³æ–¹æ¡ˆå¹³å°é€‰æ‹© `x86`ï¼Œå¹¶ç¡®ä¿ `.NET` é¡¹ç›®å·²è®¾ç½® `PlatformTarget=x86`ã€‚
3. **å·¥å…·é“¾ç¼ºå¤±**
   - ç°è±¡ï¼šæç¤ºæ‰¾ä¸åˆ° `v143` æˆ– Windows SDKã€‚
   - å¤„ç†ï¼šå®‰è£… VS2022 C++ å·¥ä½œè´Ÿè½½ä¸å¯¹åº” Windows SDKã€‚
4. **æ¸…å•æƒé™é—®é¢˜ï¼ˆInjectorï¼‰**
   - ç°è±¡ï¼šæ³¨å…¥å™¨å¯åŠ¨æ— æƒé™æˆ–æç¤º UACã€‚
   - å¤„ç†ï¼šç¡®è®¤ `Injector/app.manifest` å·²åµŒå…¥å¹¶è®¾ç½® `requireAdministrator`ã€‚

---

## é¡¶å±‚è§£å†³æ–¹æ¡ˆä¸è¾“å‡ºç›®å½•è§„èŒƒ

**è§£å†³æ–¹æ¡ˆæ–‡ä»¶**ï¼š`game-all.sln`

**å¹³å°è¦æ±‚**ï¼š

- è§£å†³æ–¹æ¡ˆå¹³å°ç»Ÿä¸€ä¸º `x86`ã€‚
- .NET é¡¹ç›®å¹³å°ä¿æŒ `Any CPU`ï¼Œä½† `PlatformTarget` å¼ºåˆ¶ä¸º `x86`ã€‚
- C++ é¡¹ç›®å¹³å°ä¸º `Win32`ã€‚

**è¾“å‡ºç›®å½•**ï¼ˆç»Ÿä¸€æ”¶æ•›åˆ° `artifacts/`ï¼‰ï¼š

- `GUI` ç›¸å…³è¾“å‡ºï¼š`artifacts/bin/`
- `Payload` è¾“å‡ºï¼š`artifacts/bin/payload/`
- `Injector` è¾“å‡ºï¼š`artifacts/bin/injector/`
- ä¸­é—´äº§ç‰©ï¼š`artifacts/obj/`

**è¯´æ˜**ï¼š

- .NET è¾“å‡ºè·¯å¾„é€šè¿‡ `Directory.Build.props` ç»Ÿä¸€ã€‚
- C++ è¾“å‡ºè·¯å¾„åœ¨ `*.vcxproj` ä¸­æ˜¾å¼æŒ‡å®šã€‚

---

## ç¬¬äº”é˜¶æ®µï¼šå…±äº«å†…å­˜ä¸€è‡´æ€§æ£€æŸ¥

è¿™æ˜¯æœ€åä¸€æ­¥ï¼Œç¡®ä¿ GUI èƒ½æ§åˆ¶ DLLã€‚

1. åœ¨ `Payload/modules/helper/HelperMod.cpp` ä¸­æœç´¢ `CreateFileMapping`ï¼Œç¡®è®¤åç§°ä¸ºï¼š
   `"Global\\GameHelperStatus_"` (æˆ–è€…æ‚¨å®šä¹‰çš„ç‰¹å®šåç§°)
2. åœ¨ `GUI` é¡¹ç›®çš„ C# ä»£ç ä¸­ï¼Œç¡®ä¿ `SharedMemoryReader` ä½¿ç”¨**å®Œå…¨ç›¸åŒ**çš„å­—ç¬¦ä¸²å‰ç¼€ã€‚

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œç‚¹å‡» Visual Studio çš„  **"ç”Ÿæˆè§£å†³æ–¹æ¡ˆ"** ï¼Œæ‚¨å°†åœ¨ Release ç›®å½•ä¸‹å¾—åˆ° `game-payload.dll` å’Œ `game-injector.exe`ï¼Œç›´æ¥è¿è¡Œ Injector å³å¯å¼€å§‹ä½¿ç”¨ã€‚

---

## MasterGUI åŠé›†æˆè¯´æ˜

**å®šä½**ï¼šMasterGUI è´Ÿè´£â€œæ§åˆ¶ä¸å±•ç¤ºâ€ï¼Œä¸ç›´æ¥æ¥ç®¡æ³¨å…¥å™¨é€»è¾‘ã€‚

**å…·ä½“è¡Œä¸º**ï¼š

1. æä¾›â€œå¿«æ·å…¥å£â€æŒ‰é’®ï¼ˆä¾‹å¦‚ï¼šæ‰“å¼€æ³¨å…¥å™¨ç›®å½•æˆ–æç¤ºè¿è¡Œ Injectorï¼‰ã€‚
2. é€šè¿‡å…±äº«å†…å­˜æ£€æµ‹çŠ¶æ€ï¼š
   - Helperï¼šè¯»å– `GameHelperStatus_{pid}` å¿ƒè·³æˆ–çŠ¶æ€å­—æ®µã€‚
   - Syncï¼šè¯»å– `DNFSyncBox.KeyboardState.V2` å¿ƒè·³æˆ–åºåˆ—å·å˜åŒ–ã€‚
3. çŠ¶æ€æ å±•ç¤ºï¼š
   - æœªæ³¨å…¥ / è¿è¡Œä¸­ / è¶…æ—¶å¤±è” ç­‰çŠ¶æ€æç¤ºã€‚

**ä¼˜åŠ¿**ï¼š

- æƒé™ä¸å®‰å…¨é£é™©æ›´ä½ã€‚
- å·¥ç¨‹è€¦åˆæ›´å°ï¼Œä¾¿äºåæœŸç»´æŠ¤ã€‚
- ç”¨æˆ·ä½“éªŒæ”¹å–„ä½†ä¸ç‰ºç‰²ç¨³å®šæ€§ã€‚

---

## GUI é›†æˆç»†åˆ™ï¼ˆå·¥ç¨‹è½åœ°ï¼‰

1. **ä¸»çª—å£ç»“æ„**ï¼š
   - ä½¿ç”¨ `TabControl` æ‰¿è½½ä¸¤ä¸ªæ¨¡å—é¡µï¼šHelper / Syncã€‚
   - åº•éƒ¨ç»Ÿä¸€çŠ¶æ€æ å±•ç¤ºæ³¨å…¥çŠ¶æ€ä¸å¿ƒè·³ç»“æœã€‚
2. **çŠ¶æ€å±•ç¤ºæ¥æº**ï¼š
   - Helperï¼šè¯»å– `GameHelperStatus_{pid}` å¿ƒè·³æˆ–çŠ¶æ€å­—æ®µã€‚
   - Syncï¼šè¯»å– `DNFSyncBox.KeyboardState.V2` çš„ `LastTick/Seq`ã€‚
3. **å¿«æ·å…¥å£**ï¼š
   - æä¾›â€œæ‰“å¼€æ³¨å…¥å™¨ç›®å½•â€æˆ–â€œæç¤ºè¿è¡Œ Injectorâ€çš„æŒ‰é’®ã€‚
   - ä¸ç›´æ¥è§¦å‘æ³¨å…¥é€»è¾‘ã€‚
4. **å¼‚å¸¸æç¤º**ï¼š
   - å…±äº«å†…å­˜ä¸å­˜åœ¨ï¼šæç¤ºâ€œæœªæ³¨å…¥æˆ–æœªå¯åŠ¨â€ã€‚
   - å¿ƒè·³è¶…æ—¶ï¼šæç¤ºâ€œå¤±è”/å¼‚å¸¸â€ã€‚

---

## MasterGUI é…ç½®é¡¹è¯´æ˜

é…ç½®æ–‡ä»¶è·¯å¾„ï¼š`GUI/config/mastergui.json`

| é…ç½®é¡¹ | å«ä¹‰ | é»˜è®¤å€¼ |
| --- | --- | --- |
| TargetProcessNames | ç›®æ ‡è¿›ç¨‹ååˆ—è¡¨ï¼ˆä¸å« .exeï¼‰ï¼Œä¾‹å¦‚ `DNF`/`dnf` | `["DNF","dnf"]` |
| HelperHeartbeatTimeoutMs | Helper å¿ƒè·³è¶…æ—¶é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰ | `2000` |
| SyncHeartbeatTimeoutMs | Sync å¿ƒè·³è¶…æ—¶é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰ | `2000` |
| StatusIntervalMs | çŠ¶æ€åˆ·æ–°é—´éš”ï¼ˆæ¯«ç§’ï¼‰ | `1000` |
| SyncMappingName | Sync å…±äº«å†…å­˜åç§° | `Local\\DNFSyncBox.KeyboardState.V2` |
| SyncVersion | Sync åè®®ç‰ˆæœ¬ | `2` |
| SyncMappingSize | Sync æ˜ å°„å¤§å°ï¼ˆå­—èŠ‚ï¼‰ | `1824` |
| InjectorProcessNames | æ³¨å…¥å™¨è¿›ç¨‹ååˆ—è¡¨ | `["game-injector","Injector"]` |
| RequireBothModulesForInjected | æ˜¯å¦è¦æ±‚ Helper ä¸ Sync åŒæ—¶æ­£å¸¸æ‰æ˜¾ç¤ºâ€œå·²æ³¨å…¥â€ | `false` |

## éªŒæ”¶æ ‡å‡†ï¼ˆå®Œæˆå®šä¹‰ï¼‰

1. **æ„å»ºä¸€è‡´**ï¼šä¸‰ç»„ä»¶åœ¨ `x86` ä¸‹æˆåŠŸç¼–è¯‘ã€‚
2. **æ¡†æ¶ä¸€è‡´**ï¼šæ‰€æœ‰ GUI é¡¹ç›®ç›®æ ‡æ¡†æ¶ç»Ÿä¸€ä¸º `net8.0-windows`ã€‚
3. **åè®®ä¸€è‡´**ï¼šC++/C# ä¸ `Shared/Protocols/åè®®è¯´æ˜.md` å¯¹é½ï¼Œç‰ˆæœ¬/å¤§å°æ ¡éªŒç”Ÿæ•ˆã€‚
4. **GUI å¯ç”¨**ï¼šä¸»çª—å£æ­£å¸¸åŠ è½½ä¸¤ä¸ªæ¨¡å—é¡µï¼ŒçŠ¶æ€æ æœ‰å®æ—¶çŠ¶æ€æ›´æ–°ã€‚
5. **åŠé›†æˆç”Ÿæ•ˆ**ï¼šGUI æä¾›å¿«æ·å…¥å£ä¸”ä¸ä¼šç›´æ¥æ“æ§æ³¨å…¥é€»è¾‘ã€‚

---

## è¿‘æœŸæ”¹åŠ¨æ‘˜è¦ï¼ˆè½åœ°ï¼‰

1. **Injector å¹¶å‘æ³¨å…¥ä»»åŠ¡åŒ–**
   - å‘ç°æ–°è¿›ç¨‹åç‹¬ç«‹çº¿ç¨‹ç­‰å¾…çª—å£ â†’ å›ºå®šç­‰å¾… 10s â†’ æ³¨å…¥
   - é¿å…å•è¿›ç¨‹é˜»å¡å…¨å±€æ‰«æ
2. **åˆ‡çª— Grace + é«˜é¢‘å‰å°æ£€æµ‹**
   - åˆ‡æ¢çª—å£åçŸ­æ—¶é—´å†…ä¿æŒæœ‰æ•ˆå‰å° PIDï¼Œå‡å°‘è¾“å…¥ç©ºçª—
3. **å…±äº«å¿ƒè·³è¶…æ—¶å¯é…ç½®**
   - é»˜è®¤æå‡è‡³ 500msï¼Œå¹¶æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–
4. **è¿å‘é”®è¾¹æ²¿åˆæˆ**
   - æ”¯æŒ RepeatKeys/RepeatIntervalMsï¼Œé»˜è®¤ X è¿å‘
5. **æ€§èƒ½ä¼˜åŒ–**
   - å…±äº«å¿«ç…§çŸ­ç¼“å­˜ï¼ˆé»˜è®¤ 2msï¼‰
   - RawInput æ—¥å¿—å¯å¼€å…³ä¸é‡‡æ ·
6. **Payload æ¨¡å—æ€»å¼€å…³**
   - æ”¯æŒ payload.ini æ§åˆ¶ Helper/Sync æ˜¯å¦å¯ç”¨
   - å…³é—­æ¨¡å—ä»ä¿ç•™ successfile

---

## é…ç½®æ¨¡æ¿æ›´æ–°

1. `config-templates/injector.ini`
   - æ–°å¢ï¼š`window_wait_timeout_ms`ã€`window_poll_interval_ms`ã€`post_window_delay_ms`ã€`max_concurrent_tasks`
   - `inject_delay_ms` é»˜è®¤æ”¹ä¸º 0ï¼ˆé¿å…å åŠ ç­‰å¾…ï¼‰
2. `config-templates/profiles.json`
   - æ–°å¢è¿å‘é”®å­—æ®µï¼š`RepeatKeys`ã€`RepeatIntervalMs`
3. `config-templates/payload.ini`
   - æ–°å¢æ¨¡å—æ€»å¼€å…³ï¼š`EnableHelper`ã€`EnableSync`

---

## è¿è¡Œå‚æ•°ï¼ˆç¯å¢ƒå˜é‡ï¼‰

Payload ç›¸å…³ï¼š
- `DNFSYNC_SPOOF_DELAY_MS`ï¼šæ³¨å…¥åä¼ªé€ å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
- `DNFSYNC_HEARTBEAT_TIMEOUT_MS`ï¼šå…±äº«å¿ƒè·³è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
- `DNFSYNC_SNAPSHOT_CACHE_MS`ï¼šå…±äº«å¿«ç…§ç¼“å­˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- `DNFSYNC_RAWINPUT_LOG`ï¼šRawInput æ—¥å¿—å¼€å…³ï¼ˆ1/true/yes/onï¼‰
- `DNFSYNC_RAWINPUT_LOG_INTERVAL_MS`ï¼šRawInput æ—¥å¿—é‡‡æ ·é—´éš”ï¼ˆæ¯«ç§’ï¼‰
- `DNFSYNC_FORCE_DI_OK`ï¼šDirectInput è¿”å› DIERR_NOTACQUIRED æ—¶å¼ºåˆ¶ DI_OK

Sync é…ç½®æ–‡ä»¶ï¼š
- `profiles.json` é»˜è®¤ä½ç½®ï¼š`%AppData%\\DNFSyncBox\\profiles.json`
- å¯å‚è€ƒæ¨¡æ¿ï¼š`config-templates/profiles.json`
