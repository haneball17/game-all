以下为基于当前 `Payload/modules/sync/SyncMod.cpp` 代码现状的补充优化方案。重点聚焦“高频 Hook 路径的无效工作量削减”和“日志/统计开销的可控化”，不涉及大规模结构重写，确保低风险可落地。

---

# SyncMod 综合优化补充方案

## 1. 目标与范围

**目标**：在保持现有功能稳定的前提下，继续降低高频 Hook 带来的 CPU 与内存拷贝开销，减少切窗卡顿与输入延迟，并提升运行时的可控性与可观测性。

**范围**：仅针对 `SyncMod.cpp` 的现有 Hook 与共享内存读写路径进行“细粒度优化”，不引入新依赖，不改动协议，不改变功能行为。

---

## 2. 可继续优化点清单（按优先级）

### 2.1 高频 Hook 的“轻量判定 + 快路径”分层（最高优先级）

**问题**：`GetAsyncKeyState/GetKeyboardState/GetRawInputData` 等 Hook 每次调用都读取完整共享快照（含 256 字节键盘态等），即便当前不需要同步也做了大量无效工作。

**优化思路**：
- 增加“轻量快照读取”（只读取 `flags/profileMode/lastTick` 等判断字段）。
- 仅在“确需同步/映射”的情况下读取完整快照。

**优势**：减少高频 Hook 中的内存拷贝和原子操作，CPU 消耗显著下降，尤其在未启用同步/无目标进程时收益明显。

**举例**：
- `Hook_GetAsyncKeyState`：先读取轻量字段判定“是否处于同步模式”。若否，直接返回原始结果，不再读取完整键盘态数组。

---

### 2.2 统计与日志可控化（高优先级）

**问题**：目前每个 Hook 都做 `InterlockedIncrement`，并且每秒固定输出统计日志，生产环境中存在持续开销。

**优化思路**：
- 引入运行时开关（如 `DNFSYNC_STATS=0/1`），关闭时完全禁用计数与统计输出。
- 统计日志节流间隔改为可配置，避免固定 1 秒频率。

**优势**：在非排查场景下显著降低 CPU 与磁盘 I/O 开销。

**举例**：
- 默认关闭 `DNFSYNC_STATS`；排查“输入丢失”时再临时开启。

---

### 2.3 RawInput 重写逻辑降频（中高优先级）

**问题**：RawInput 路径（`Hook_GetRawInputData/Buffer`）即使在非同步状态仍会执行大量判定与可能的重写逻辑。

**优化思路**：
- 在进入 RawInput 重写逻辑前增加快速条件判断（是否同步/是否有目标/是否启用映射）。
- 不满足条件时直接返回原始结果，避免进入复杂路径。

**优势**：减少 RawInput 路径上的分支与内存访问，降低切窗后“短暂停顿”的概率。

---

### 2.4 消息钩子条件化（中优先级）

**问题**：`GetMessage/PeekMessage` 被全量 Hook，即使当前未使用 RawInput 修复也会带来额外开销。

**优化思路**：
- 仅在启用“RawInput 伪造/映射”功能时安装消息钩子。
- 或在回调中快速判断“是否需要修复”，否则直接返回。

**优势**：缩小 Hook 覆盖面，减少系统级干扰。

---

### 2.5 焦点伪造短路判定（中优先级）

**问题**：`GetForegroundWindow/GetActiveWindow/GetFocus` 每次都做窗口归属判定，涉及 `GetWindowThreadProcessId` 及缓存读取。

**优化思路**：
- 增加“是否需要伪造焦点”的状态判定，若不需要则直接返回原函数结果。

**优势**：减少大量无意义的窗口归属判断。

---

### 2.6 共享快照“序号复用”降低 memcpy（中优先级）

**问题**：即便共享内存无变化，仍会频繁 memcpy 复制 256 字节键盘态等内容。

**优化思路**：
- 在缓存层增加 seq 对比：若 `seq` 未变则复用上次快照数据。

**优势**：在稳定状态下几乎零拷贝，进一步降低高频 Hook 成本。

---

## 3. 建议实施顺序

1. **轻量判定 + 快路径分层**（收益最大、风险最低）
2. **统计/日志开关化**（简单、立竿见影）
3. **RawInput 重写降频**
4. **消息钩子条件化**
5. **焦点伪造短路判定**
6. **共享快照序号复用**

---

## 4. 预期收益

- 高频 Hook 的平均耗时下降，整体 CPU 使用率降低。
- 切窗/后台运行时输入响应更稳定。
- 统计日志开销可控，避免长期 IO 负担。
- 可观测性更灵活：调试时打开统计，生产时关闭。

---

## 5. 风险与回退策略

- **风险**：快路径判定条件不严谨可能导致同步失效。
- **应对**：
  - 保留“完整快照读取”兜底路径；
  - 关键判定引入日志（仅调试打开）；
  - 通过开关回退到旧逻辑（如 `DNFSYNC_FASTPATH=0`）。

---

## 6. 结论

SyncMod 已完成第一轮性能优化，但仍存在高频 Hook 的无效开销与日志统计常驻开销问题。本补充方案以“低风险、可回退”为设计核心，适合在不改变功能行为的前提下继续优化性能与稳定性。

