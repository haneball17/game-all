# PEB Unlink å®ç°æ–¹æ¡ˆ

> **ç›®æ ‡**: ä¸º game-all é¡¹ç›®å®ç° PEB Unlink æ¨¡å—éšè—åŠŸèƒ½  
> **ä½œè€…**: Claude Code  
> **æ—¥æœŸ**: 2026-02-18  
> **ç‰ˆæœ¬**: 1.0

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
2. [å®ç°æ­¥éª¤](#å®ç°æ­¥éª¤)
3. [ä»£ç æ¡†æ¶](#ä»£ç æ¡†æ¶)
4. [é›†æˆç­–ç•¥](#é›†æˆç­–ç•¥)
5. [æµ‹è¯•æ–¹æ¡ˆ](#æµ‹è¯•æ–¹æ¡ˆ)
6. [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)

---

## ğŸ— æ¶æ„è®¾è®¡

### æ¨¡å—ç»“æ„

```
Payload/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ helper/
â”‚   â”‚   â””â”€â”€ helper.cpp          # ç°æœ‰Helperæ¨¡å—
â”‚   â”œâ”€â”€ sync/
â”‚   â”‚   â””â”€â”€ sync.cpp            # ç°æœ‰Syncæ¨¡å—
â”‚   â””â”€â”€ stealth/                # æ–°å¢éšè”½æ¨¡å—
â”‚       â”œâ”€â”€ peb_utils.h         # PEBæ“ä½œå·¥å…·
â”‚       â”œâ”€â”€ peb_utils.cpp       # PEBæ“ä½œå®ç°
â”‚       â”œâ”€â”€ module_hider.h      # æ¨¡å—éšè—æ¥å£
â”‚       â””â”€â”€ module_hider.cpp    # Unlinkå®ç°
â””â”€â”€ entry.cpp                   # Payloadå…¥å£

æ–°çš„æ¨¡å—èŒè´£:
â”œâ”€ peb_utils: å°è£…PEBè®¿é—®ã€é“¾è¡¨éå†ç­‰åº•å±‚æ“ä½œ
â”œâ”€ module_hider: å®ç°Unlinké€»è¾‘ï¼Œæä¾›éšè—/æ˜¾ç¤ºæ¥å£
â””â”€ ç°æœ‰æ¨¡å—: è°ƒç”¨module_hiderå®ç°è‡ªæˆ‘éšè—
```

### è®¾è®¡åŸåˆ™

```
1. æœ€å°ä¾µå…¥
   â†’ ä¸ä¿®æ”¹ç°æœ‰Helper/Syncæ ¸å¿ƒé€»è¾‘
   â†’ é€šè¿‡ç‹¬ç«‹æ¨¡å—æä¾›åŠŸèƒ½

2. å¯é…ç½®å¼€å…³
   â†’ æ”¯æŒè¿è¡Œæ—¶å¯ç”¨/ç¦ç”¨
   â†’ ä¾¿äºè°ƒè¯•å’Œé—®é¢˜æ’æŸ¥

3. å¹³å°å…¼å®¹
   â†’ å½“å‰æ”¯æŒx86
   â†’ é¢„ç•™x64æ‰©å±•èƒ½åŠ›

4. å®‰å…¨æ€§
   â†’ å¤±è´¥æ—¶ä¸å½±å“DLLæ­£å¸¸è¿è¡Œ
   â†’ å®Œå–„çš„é”™è¯¯å¤„ç†
```

---

## ğŸ“ å®ç°æ­¥éª¤

### Phase 1: åŸºç¡€ç»“æ„ï¼ˆ1-2å°æ—¶ï¼‰
```
âœ“ åˆ›å»ºstealthæ¨¡å—ç›®å½•
âœ“ ç¼–å†™peb_utils.hå¤´æ–‡ä»¶
âœ“ å®šä¹‰PEBç›¸å…³ç»“æ„ä½“
âœ“ ç¼–å†™åŸºæœ¬æ¡†æ¶ä»£ç 
```

### Phase 2: PEBè®¿é—®ï¼ˆ2-3å°æ—¶ï¼‰
```
âœ“ å®ç°è·å–å½“å‰è¿›ç¨‹PEB
âœ“ å®ç°è¯»å–Ldré“¾è¡¨
âœ“ å®ç°æ¨¡å—éå†å‡½æ•°
âœ“ æ·»åŠ è°ƒè¯•è¾“å‡º
```

### Phase 3: Unlinkæ ¸å¿ƒï¼ˆ3-4å°æ—¶ï¼‰
```
âœ“ å®ç°é“¾è¡¨Unlinkæ“ä½œ
âœ“ å¤„ç†3ä¸ªé“¾è¡¨ï¼ˆLoadOrder/MemoryOrder/InitOrderï¼‰
âœ“ æ·»åŠ è¾¹ç•Œæ£€æŸ¥
âœ“ é”™è¯¯å¤„ç†
```

### Phase 4: é›†æˆä¸æµ‹è¯•ï¼ˆ2-3å°æ—¶ï¼‰
```
âœ“ åœ¨Helperæ¨¡å—ä¸­è°ƒç”¨
âœ“ åœ¨Syncæ¨¡å—ä¸­è°ƒç”¨
âœ“ ç¼–å†™éªŒè¯ä»£ç 
âœ“ æµ‹è¯•å„ç§åœºæ™¯
```

### Phase 5: ä¼˜åŒ–ä¸æ–‡æ¡£ï¼ˆ1-2å°æ—¶ï¼‰
```
âœ“ æ€§èƒ½ä¼˜åŒ–
âœ“ æ·»åŠ è¯¦ç»†æ³¨é‡Š
âœ“ ç¼–å†™ä½¿ç”¨æ–‡æ¡£
âœ“ å‡†å¤‡æ¼”ç¤º
```

**æ€»é¢„è®¡æ—¶é—´**: 9-14å°æ—¶

---

## ğŸ’» ä»£ç æ¡†æ¶

> å®Œæ•´ä»£ç å®ç°è¯·å‚è€ƒ [04-ä»£ç æ¨¡æ¿.md](./04-ä»£ç æ¨¡æ¿.md)

### ä¸»è¦ç»„ä»¶

#### 1. PEBUtils ç±»

è´Ÿè´£PEBè®¿é—®å’Œæ¨¡å—éå†ï¼š

```cpp
namespace stealth {

class PEBUtils {
public:
    // è·å–å½“å‰è¿›ç¨‹PEB
    static PVOID GetCurrentPEB();
    
    // è·å–LDRæ•°æ®
    static PEB_LDR_DATA* GetLdrData(PVOID peb);
    
    // éå†æ‰€æœ‰æ¨¡å—
    static bool EnumModules(ModuleEnumCallback callback, void* context);
    
    // é€šè¿‡åç§°æŸ¥æ‰¾æ¨¡å—
    static LDR_DATA_TABLE_ENTRY* FindModuleByName(const wchar_t* moduleName);
    
    // é€šè¿‡åŸºåœ°å€æŸ¥æ‰¾æ¨¡å—
    static LDR_DATA_TABLE_ENTRY* FindModuleByBaseAddress(PVOID baseAddress);
    
    // è·å–å½“å‰æ¨¡å—åŸºåœ°å€
    static PVOID GetCurrentModuleBase();
};

}
```

#### 2. ModuleHider ç±»

è´Ÿè´£æ‰§è¡ŒUnlinkæ“ä½œï¼š

```cpp
namespace stealth {

class ModuleHider {
public:
    // éšè—å½“å‰æ¨¡å—
    static bool HideCurrentModule();
    
    // é€šè¿‡åç§°éšè—æ¨¡å—
    static bool HideModuleByName(const wchar_t* moduleName);
    
    // é€šè¿‡åŸºåœ°å€éšè—æ¨¡å—
    static bool HideModuleByBaseAddress(PVOID baseAddress);
    
    // æ£€æŸ¥æ¨¡å—æ˜¯å¦å·²éšè—
    static bool IsModuleHidden(const wchar_t* moduleName);
    
    // è·å–é”™è¯¯ä¿¡æ¯
    static const wchar_t* GetLastErrorMsg();
};

}
```

---

## ğŸ”— é›†æˆç­–ç•¥

### åœ¨ç°æœ‰æ¨¡å—ä¸­è°ƒç”¨

```cpp
// åœ¨ modules/helper/helper.cpp çš„DllMainä¸­

#include "../stealth/module_hider.h"

BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved) {
    switch (ul_reason_for_call) {
    case DLL_PROCESS_ATTACH:
        {
            // åŸæœ‰åˆå§‹åŒ–ä»£ç ...
            
            // æ–°å¢ï¼šéšè—æ¨¡å—
            #ifdef ENABLE_STEALTH_MODE
            printf("[Helper] Enabling stealth mode...\n");
            if (stealth::ModuleHider::HideCurrentModule()) {
                printf("[Helper] Successfully hidden from module list\n");
            } else {
                printf("[Helper] Failed to hide: %ls\n", 
                       stealth::ModuleHider::GetLastErrorMsg());
            }
            #endif
            
            break;
        }
    case DLL_PROCESS_DETACH:
        // æ¸…ç†ä»£ç ...
        break;
    }
    return TRUE;
}
```

### é…ç½®å¼€å…³æ§åˆ¶

```cpp
// config.h
#pragma once

// ç¼–è¯‘æ—¶å¼€å…³
#define ENABLE_STEALTH_MODE 1  // 1=å¯ç”¨, 0=ç¦ç”¨

// è¿è¡Œæ—¶å¼€å…³ï¼ˆé€šè¿‡å…±äº«å†…å­˜é…ç½®ï¼‰
struct StealthConfig {
    bool enablePebUnlink;
    bool enableVerboseLogging;
};
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ¡ˆ

### æµ‹è¯•å·¥å…·ï¼štest_enumeration.cpp

```cpp
#include <windows.h>
#include <stdio.h>
#include <tlhelp32.h>
#include <psapi.h>

// æµ‹è¯•å‡½æ•°ï¼šæ£€æŸ¥æ¨¡å—æ˜¯å¦å¯è§
bool IsModuleVisible(const wchar_t* moduleName) {
    HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPMODULE, GetCurrentProcessId());
    if (hSnapshot == INVALID_HANDLE_VALUE) {
        printf("Failed to create snapshot\n");
        return false;
    }
    
    MODULEENTRY32W me32;
    me32.dwSize = sizeof(me32);
    
    if (!Module32FirstW(hSnapshot, &me32)) {
        CloseHandle(hSnapshot);
        return false;
    }
    
    bool found = false;
    do {
        if (_wcsicmp(me32.szModule, moduleName) == 0) {
            found = true;
            printf("Found module: %ls at 0x%p\n", me32.szModule, me32.modBaseAddr);
            break;
        }
    } while (Module32NextW(hSnapshot, &me32));
    
    CloseHandle(hSnapshot);
    return found;
}

int main() {
    const wchar_t* targetModule = L"game-payload.dll";
    
    printf("=== Module Visibility Test ===\n\n");
    
    bool visible = IsModuleVisible(targetModule);
    printf("Result: %s\n", visible ? "VISIBLE" : "HIDDEN");
    
    printf("\nPress any key to exit...\n");
    getchar();
    return 0;
}
```

### æµ‹è¯•æ­¥éª¤

```
1. ç¼–è¯‘Payload
   â†’ ç¡®ä¿stealthæ¨¡å—å·²é›†æˆ

2. ä½¿ç”¨Injectoræ³¨å…¥åˆ°æµ‹è¯•è¿›ç¨‹
   â†’ notepad.exeæˆ–è‡ªå®šä¹‰æµ‹è¯•ç¨‹åº

3. åœ¨æµ‹è¯•è¿›ç¨‹ä¸­è¿è¡Œtest_enumeration.exe
   â†’ æ³¨å…¥å‰ï¼šæ¨¡å—å¯è§
   â†’ æ³¨å…¥åï¼šæ¨¡å—åº”è¯¥éšè—

4. ä½¿ç”¨Process HackeréªŒè¯
   â†’ æ‰“å¼€Process Hacker
   â†’ æŸ¥çœ‹ç›®æ ‡è¿›ç¨‹çš„æ¨¡å—åˆ—è¡¨
   â†’ game-payload.dllä¸åº”è¯¥å‡ºç°

5. ä½¿ç”¨Process ExploreréªŒè¯
   â†’ åŒä¸Šï¼ŒéªŒè¯å¤šç§å·¥å…·

6. æµ‹è¯•DLLåŠŸèƒ½
   â†’ ç¡®ä¿éšè—ååŠŸèƒ½ä»ç„¶æ­£å¸¸
   â†’ Helper/Syncä»ç„¶å·¥ä½œ

7. ç”ŸæˆMinidumpæµ‹è¯•
   â†’ ä½¿ç”¨MiniDumpWriteDump
   â†’ åˆ†ædumpä¸­æ¨¡å—åˆ—è¡¨
   â†’ åº”è¯¥ä¸åŒ…å«game-payload.dll
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å®‰å…¨æ€§

1. **å¤±è´¥ä¸å½±å“åŠŸèƒ½**
   ```cpp
   try {
       stealth::ModuleHider::HideCurrentModule();
   } catch (...) {
       // éšè—å¤±è´¥ï¼Œä½†DLLä»ç„¶å·¥ä½œ
       printf("[Stealth] Hide failed, continuing anyway\n");
   }
   ```

2. **å¤šæ¬¡è°ƒç”¨ä¿æŠ¤**
   ```cpp
   // é¿å…é‡å¤Unlinkå¯¼è‡´å´©æºƒ
   static bool s_hidden = false;
   if (!s_hidden) {
       HideCurrentModule();
       s_hidden = true;
   }
   ```

3. **ä»…éšè—è‡ªå·±çš„æ¨¡å—**
   ```cpp
   // ä¸è¦éšè—å…¶ä»–DLL
   // åªè°ƒç”¨HideCurrentModule()
   ```

### è°ƒè¯•æŠ€å·§

1. **è¯¦ç»†æ—¥å¿—**
   ```cpp
   #define STEALTH_VERBOSE 1
   #ifdef STEALTH_VERBOSE
       printf("[Stealth] Detailed info...\n");
   #endif
   ```

2. **é€æ­¥éªŒè¯**
   ```cpp
   // éªŒè¯PEBè·å–
   PVOID peb = PEBUtils::GetCurrentPEB();
   printf("PEB: 0x%p\n", peb);
   
   // éªŒè¯æ¨¡å—æŸ¥æ‰¾
   auto entry = PEBUtils::FindModuleByName(L"game-payload.dll");
   printf("Found: 0x%p\n", entry);
   
   // æœ€åæ‰æ‰§è¡ŒUnlink
   ModuleHider::HideCurrentModule();
   ```

3. **ä½¿ç”¨è°ƒè¯•å™¨**
   - åœ¨WinDbgä¸­è®¾ç½®æ–­ç‚¹
   - æŸ¥çœ‹PEBç»“æ„: `dt nt!_PEB`
   - æŸ¥çœ‹LDR: `dt nt!_PEB_LDR_DATA`

### å…¼å®¹æ€§

1. **x86 vs x64**
   ```cpp
   #ifdef _M_IX86
       // x86ä»£ç 
   #elif defined(_M_X64)
       // x64ä»£ç ï¼ˆç»“æ„ä½“åç§»ä¸åŒï¼‰
   #endif
   ```

2. **Windowsç‰ˆæœ¬**
   - Windows XP: å¯èƒ½ä¸æ”¯æŒæŸäº›API
   - Windows 7+: å…¨éƒ¨åŠŸèƒ½
   - Windows 10/11: æµ‹è¯•é‡ç‚¹

3. **DEP/ASLR**
   - ç¡®ä¿ç¼–è¯‘æ—¶æ­£ç¡®è®¾ç½®
   - æµ‹è¯•DEPå¼€å¯çš„ç¯å¢ƒ

---

## ğŸ“Š å¼€å‘è¿›åº¦è·Ÿè¸ª

### Phase 1: åŸºç¡€ç»“æ„ (Day 1)
- [ ] åˆ›å»ºstealthç›®å½•
- [ ] ç¼–å†™peb_utils.h
- [ ] ç¼–å†™module_hider.h
- [ ] è®¾ç½®ç¼–è¯‘é…ç½®

### Phase 2: PEBè®¿é—® (Day 1-2)
- [ ] å®ç°GetCurrentPEB()
- [ ] å®ç°GetLdrData()
- [ ] å®ç°EnumModules()
- [ ] å®ç°FindModuleByName()
- [ ] å•å…ƒæµ‹è¯•

### Phase 3: Unlinkæ ¸å¿ƒ (Day 2-3)
- [ ] å®ç°UnlinkModule()
- [ ] å®ç°ValidateLinks()
- [ ] é”™è¯¯å¤„ç†
- [ ] é›†æˆæµ‹è¯•

### Phase 4: é›†æˆ (Day 3-4)
- [ ] åœ¨Helperä¸­è°ƒç”¨
- [ ] åœ¨Syncä¸­è°ƒç”¨
- [ ] é…ç½®å¼€å…³
- [ ] å®Œæ•´æµ‹è¯•

### Phase 5: éªŒè¯ä¸ä¼˜åŒ– (Day 4-5)
- [ ] Process Hackeræµ‹è¯•
- [ ] Process Exploreræµ‹è¯•
- [ ] Minidumpæµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ–‡æ¡£ç¼–å†™

---

## ğŸ¯ é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | æ ‡å‡† | é¢„è®¡æ—¶é—´ |
|--------|------|---------|
| M1: åŸºç¡€æ¡†æ¶ | ä»£ç ç¼–è¯‘é€šè¿‡ï¼ŒåŸºæœ¬ç»“æ„å®Œæˆ | Day 1 |
| M2: PEBè®¿é—®æˆåŠŸ | èƒ½æ­£ç¡®éå†æ¨¡å—åˆ—è¡¨ | Day 2 |
| M3: UnlinkæˆåŠŸ | Process Hackerçœ‹ä¸åˆ°æ¨¡å— | Day 3 |
| M4: é›†æˆå®Œæˆ | åœ¨å®é™…æ³¨å…¥ä¸­ç”Ÿæ•ˆ | Day 4 |
| M5: å…¨éƒ¨æµ‹è¯•é€šè¿‡ | æ‰€æœ‰æµ‹è¯•åœºæ™¯é€šè¿‡ | Day 5 |

---

## ğŸ“š å‚è€ƒèµ„æº

- Microsoft PE/COFFæ ¼å¼è§„èŒƒ
- Windows Internals 7th Edition
- BlackHat/DefConç›¸å…³æ¼”è®²
- GitHubå¼€æºé¡¹ç›®ï¼ˆå¦‚: BlackBone, Duenoï¼‰
