# PEB Unlink å¿«é€Ÿå¼€å§‹æŒ‡å—

> **5åˆ†é’Ÿå¿«é€Ÿå¯åŠ¨ PEB Unlink å®ç°**

---

## ğŸš€ 5æ­¥å¿«é€Ÿå¯åŠ¨

### Step 1: åˆ›å»ºç›®å½•ç»“æ„ï¼ˆ2åˆ†é’Ÿï¼‰

```bash
cd /home/ubuntu/code/game-all/Payload/modules
mkdir -p stealth
cd stealth
```

### Step 2: åˆ›å»ºæ–‡ä»¶ï¼ˆ5åˆ†é’Ÿï¼‰

ä¾æ¬¡åˆ›å»ºä»¥ä¸‹4ä¸ªæ–‡ä»¶ï¼Œå®Œæ•´ä»£ç è§ [04-ä»£ç æ¨¡æ¿.md](./04-ä»£ç æ¨¡æ¿.md)ï¼š

1. `peb_utils.h` - PEBå·¥å…·å¤´æ–‡ä»¶
2. `peb_utils.cpp` - PEBå·¥å…·å®ç°
3. `module_hider.h` - æ¨¡å—éšè—æ¥å£
4. `module_hider.cpp` - Unlinkå®ç°

### Step 3: æ›´æ–°Payload.vcxprojï¼ˆ3åˆ†é’Ÿï¼‰

åœ¨Payloadé¡¹ç›®ä¸­æ·»åŠ stealthæ¨¡å—ï¼š

```xml
<!-- åœ¨Payload.vcxprojçš„<ItemGroup>ä¸­æ·»åŠ  -->
<ClCompile Include="modules\stealth\peb_utils.cpp" />
<ClCompile Include="modules\stealth\module_hider.cpp" />
<ClInclude Include="modules\stealth\peb_utils.h" />
<ClInclude Include="modules\stealth\module_hider.h" />
```

### Step 4: é›†æˆåˆ°ç°æœ‰æ¨¡å—ï¼ˆ5åˆ†é’Ÿï¼‰

åœ¨ `modules/helper/helper.cpp` çš„ DllMain ä¸­æ·»åŠ ï¼š

```cpp
#include "../stealth/module_hider.h"

BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved) {
    switch (ul_reason_for_call) {
    case DLL_PROCESS_ATTACH:
        {
            // ç°æœ‰ä»£ç ...
            
            // æ–°å¢ï¼šéšè—æ¨¡å—
            #ifdef ENABLE_STEALTH_MODE
            printf("[Helper] Hiding module from PEB...\n");
            if (stealth::ModuleHider::HideCurrentModule()) {
                printf("[Helper] SUCCESS: Module is now hidden!\n");
            } else {
                printf("[Helper] FAILED: %ls\n", 
                       stealth::ModuleHider::GetLastErrorMsg());
            }
            #endif
            
            break;
        }
    }
    return TRUE;
}
```

### Step 5: ç¼–è¯‘æµ‹è¯•ï¼ˆ10åˆ†é’Ÿï¼‰

```bash
# 1. ç¼–è¯‘Payload
msbuild Payload.vcxproj /p:Configuration=Release /p:Platform=Win32

# 2. ç¼–è¯‘Injector
msbuild Injector.vcxproj /p:Configuration=Release /p:Platform=Win32

# 3. è¿è¡Œæµ‹è¯•
cd artifacts/run
./game-injector.exe --target notepad.exe

# 4. éªŒè¯ï¼ˆä½¿ç”¨Process Hackerï¼‰
# - æ‰“å¼€Process Hacker
# - æŸ¥çœ‹notepad.exeçš„æ¨¡å—åˆ—è¡¨
# - game-payload.dllä¸åº”è¯¥å‡ºç°ï¼
```

---

## ğŸ“¦ å®Œæ•´æ–‡ä»¶æ¸…å•

### ç›®å½•ç»“æ„

```
Payload/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ helper/
â”‚   â”‚   â””â”€â”€ helper.cpp          [ä¿®æ”¹ï¼šæ·»åŠ #includeå’Œè°ƒç”¨]
â”‚   â”œâ”€â”€ sync/
â”‚   â”‚   â””â”€â”€ sync.cpp            [ä¿®æ”¹ï¼šæ·»åŠ #includeå’Œè°ƒç”¨]
â”‚   â””â”€â”€ stealth/                [æ–°å¢ç›®å½•]
â”‚       â”œâ”€â”€ peb_utils.h         [æ–°å¢æ–‡ä»¶]
â”‚       â”œâ”€â”€ peb_utils.cpp       [æ–°å¢æ–‡ä»¶]
â”‚       â”œâ”€â”€ module_hider.h      [æ–°å¢æ–‡ä»¶]
â”‚       â””â”€â”€ module_hider.cpp    [æ–°å¢æ–‡ä»¶]
â””â”€â”€ Payload.vcxproj             [ä¿®æ”¹ï¼šæ·»åŠ æ–°æ–‡ä»¶]
```

### æ–‡ä»¶å¤§å°é¢„ä¼°

```
peb_utils.h:       ~2 KB  (~80è¡Œ)
peb_utils.cpp:     ~6 KB  (~200è¡Œ)
module_hider.h:    ~2 KB  (~70è¡Œ)
module_hider.cpp:  ~8 KB  (~250è¡Œ)
æ€»è®¡:              ~18 KB (~600è¡Œ)
```

---

## ğŸ§ª å¿«é€ŸéªŒè¯æ–¹æ³•

### æ–¹æ³•1: ä½¿ç”¨Process Hacker

```bash
1. æ‰“å¼€Process Hacker
2. æ‰¾åˆ°ç›®æ ‡è¿›ç¨‹ï¼ˆå¦‚notepad.exeï¼‰
3. å³é”® â†’ Properties â†’ Modulesæ ‡ç­¾
4. æŸ¥æ‰¾ game-payload.dll
5. é¢„æœŸç»“æœ: æ‰¾ä¸åˆ°ï¼
```

### æ–¹æ³•2: ä½¿ç”¨æµ‹è¯•å·¥å…·

åˆ›å»ºç®€å•çš„æµ‹è¯•ç¨‹åºï¼š

```cpp
// test_visibility.cpp
#include <windows.h>
#include <stdio.h>
#include <tlhelp32.h>

int main() {
    HANDLE hSnapshot = CreateToolhelp32Snapshot(
        TH32CS_SNAPMODULE, 
        GetCurrentProcessId()
    );
    
    MODULEENTRY32W me32;
    me32.dwSize = sizeof(me32);
    
    if (Module32FirstW(hSnapshot, &me32)) {
        do {
            if (wcsstr(me32.szModule, L"game-payload")) {
                printf("FOUND: %ls at 0x%p\n", 
                       me32.szModule, 
                       me32.modBaseAddr);
                CloseHandle(hSnapshot);
                return 1;  // å¯è§
            }
        } while (Module32NextW(hSnapshot, &me32));
    }
    
    printf("NOT FOUND: game-payload.dll is hidden!\n");
    CloseHandle(hSnapshot);
    return 0;  // éšè—
}
```

ç¼–è¯‘è¿è¡Œï¼š
```bash
cl.exe test_visibility.cpp
test_visibility.exe
```

### æ–¹æ³•3: WinDbgéªŒè¯

```
1. windbg notepad.exe
2. åŠ è½½payloadå
3. æ‰§è¡Œå‘½ä»¤: !peb
4. æŸ¥çœ‹Ldré“¾è¡¨
5. é¢„æœŸ: game-payload.dllä¸åœ¨åˆ—è¡¨ä¸­
```

---

## âš™ï¸ ç¼–è¯‘é…ç½®

### Visual Studioé…ç½®

```
1. æ‰“å¼€ Payload.vcxproj
2. æ·»åŠ ä¸Šè¿°æ–‡ä»¶åˆ°é¡¹ç›®
3. é…ç½®å±æ€§:
   - C/C++ â†’ Preprocessor Definitions:
     æ·»åŠ : ENABLE_STEALTH_MODE=1
   - C/C++ â†’ Language:
     Conformance mode: No (é¿å…C++æ ‡å‡†åº“å…¼å®¹æ€§é—®é¢˜)
   - Advanced:
     Compile As: C++ Code (/TP)
4. ç¼–è¯‘
```

### Makefileé…ç½®ï¼ˆå¦‚æœä½¿ç”¨ï¼‰

```makefile
# Payload/Makefile

CXX=cl.exe
CXXFLAGS=/nologo /MT /O2 /W3 /D "ENABLE_STEALTH_MODE=1"
INCLUDES=/I"modules"

STEALTH_OBJS=\
    modules/stealth/peb_utils.obj \
    modules/stealth/module_hider.obj

all: $(STEALTH_OBJS)

modules/stealth/%.obj: modules/stealth/%.cpp
    $(CXX) $(CXXFLAGS) $(INCLUDES) /c $< /Fo$@
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: ç¼–è¯‘é”™è¯¯

```
é”™è¯¯: 'GetCurrentPEB': undeclared identifier
è§£å†³: ç¡®ä¿åŒ…å«äº† <intrin.h> å’Œ <winternl.h>
```

### é—®é¢˜2: é“¾æ¥é”™è¯¯

```
é”™è¯¯: unresolved external symbol
è§£å†³: å°†æ‰€æœ‰.cppæ–‡ä»¶æ·»åŠ åˆ°vcxprojçš„<ClCompile>ä¸­
```

### é—®é¢˜3: è¿è¡Œæ—¶å´©æºƒ

```
åŸå› : å¯èƒ½æ˜¯ç»“æ„ä½“å¯¹é½é—®é¢˜
è§£å†³: ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ç»“æ„ä½“å®šä¹‰
```

### é—®é¢˜4: Unlinkå¤±è´¥

```
åŸå› : æ¨¡å—å·²ç»è¢«Unlinkæˆ–é“¾è¡¨æŸå
è§£å†³: æ·»åŠ ValidateLinksæ£€æŸ¥ï¼Œé¿å…é‡å¤Unlink
```

### é—®é¢˜5: æ¨¡å—ä»ç„¶å¯è§

```
æ’æŸ¥æ­¥éª¤:
1. æ£€æŸ¥æ˜¯å¦è°ƒç”¨HideCurrentModule()
2. æ£€æŸ¥è¿”å›å€¼å’Œé”™è¯¯ä¿¡æ¯
3. ä½¿ç”¨è°ƒè¯•å™¨éªŒè¯PEBç»“æ„
4. ç¡®è®¤åœ¨æ­£ç¡®çš„æ—¶æœºè°ƒç”¨ï¼ˆDLL_PROCESS_ATTACHï¼‰
```

---

## ğŸ“Š æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŸºæœ¬åŠŸèƒ½æµ‹è¯•

- [ ] ç¼–è¯‘é€šè¿‡ï¼Œæ— è­¦å‘Š
- [ ] æ³¨å…¥æˆåŠŸï¼Œè¿›ç¨‹ä¸å´©æºƒ
- [ ] Helper/SyncåŠŸèƒ½æ­£å¸¸
- [ ] Process Hackerçœ‹ä¸åˆ°æ¨¡å—
- [ ] Process Explorerçœ‹ä¸åˆ°æ¨¡å—
- [ ] CreateToolhelp32Snapshotçœ‹ä¸åˆ°
- [ ] EnumProcessModulesçœ‹ä¸åˆ°

### å‹åŠ›æµ‹è¯•

- [ ] å¤šæ¬¡æ³¨å…¥/å¸è½½
- [ ] é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§
- [ ] å¤šè¿›ç¨‹å¹¶å‘æ³¨å…¥
- [ ] ä½å†…å­˜ç¯å¢ƒæµ‹è¯•

### è¾¹ç¼˜æƒ…å†µ

- [ ] é‡å¤è°ƒç”¨HideCurrentModule()ï¼ˆåº”è¯¥å®‰å…¨ï¼‰
- [ ] éšè—åè°ƒç”¨FreeLibraryï¼ˆåº”è¯¥ä¸å´©æºƒï¼‰
- [ ] éšè—å…¶ä»–DLLçš„æ¨¡å—ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
- [ ] åœ¨DLL_PROCESS_DETACHæ—¶æ£€æŸ¥çŠ¶æ€

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### å®ŒæˆPEB Unlinkåï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **å¢å¼ºéšè”½æ€§**
   - æ¸…é™¤PEå¤´ç‰¹å¾
   - æ“¦é™¤å¯¼å‡ºè¡¨
   - æ··æ·†ä»£ç æ®µ

2. **æ·»åŠ æ›´å¤šåŠŸèƒ½**
   - Hook NtQueryInformationProcess
   - æ‹¦æˆªMiniDumpWriteDump
   - ä¼ªé€ VADæ ‘è®°å½•

3. **å‡çº§åˆ°Manual Map**
   - å®Œå…¨ç»•è¿‡LoadLibrary
   - æ›´é«˜çº§çš„éšè”½æ€§
   - æ›´éš¾è¢«æ£€æµ‹

---

## ğŸ“ è·å–å¸®åŠ©

### è°ƒè¯•æŠ€å·§

```cpp
// æ·»åŠ è¯¦ç»†æ—¥å¿—
#define STEALTH_DEBUG 1
#ifdef STEALTH_DEBUG
    #define DBG_PRINT(fmt, ...) printf(fmt, ##__VA_ARGS__)
#else
    #define DBG_PRINT(fmt, ...) ((void)0)
#endif

// ä½¿ç”¨æ–¹å¼
DBG_PRINT("[Stealth] PEB: 0x%p\n", peb);
DBG_PRINT("[Stealth] Module found: %ls\n", moduleName);
```

### ä½¿ç”¨WinDbg

```
å¸¸ç”¨å‘½ä»¤:
!peb                    - æŸ¥çœ‹PEBç»“æ„
dt nt!_PEB              - æ˜¾ç¤ºPEBè¯¦ç»†å®šä¹‰
!peb -l                 - æŸ¥çœ‹åŠ è½½çš„æ¨¡å—
lm                      - åˆ—å‡ºæ¨¡å—
!address                - æŸ¥çœ‹å†…å­˜å¸ƒå±€
```

---

## âœ… æˆåŠŸæ ‡å‡†

å½“ä»¥ä¸‹æ¡ä»¶å…¨éƒ¨æ»¡è¶³æ—¶ï¼ŒPEB Unlinkå®ç°æˆåŠŸï¼š

1. âœ… ä»£ç ç¼–è¯‘é€šè¿‡
2. âœ… æ³¨å…¥åè¿›ç¨‹ç¨³å®šè¿è¡Œ
3. âœ… Process Hackerçœ‹ä¸åˆ°game-payload.dll
4. âœ… Process Explorerçœ‹ä¸åˆ°game-payload.dll
5. âœ… æµ‹è¯•å·¥å…·éªŒè¯æ¨¡å—éšè—
6. âœ… Helper/SyncåŠŸèƒ½æ­£å¸¸å·¥ä½œ
7. âœ… Minidumpä¸åŒ…å«game-payload.dllè®°å½•

æ­å–œï¼ä½ å·²ç»æˆåŠŸå®ç°äº†PEB Unlinkï¼ğŸ‰

---

## ğŸ“š å‚è€ƒèµ„æº

- Microsoft PE Format Documentation
- Windows Internals (ç¬¬7ç‰ˆ)
- ReactOS PEBç»“æ„å®šä¹‰
- BlackBoneå¼€æºé¡¹ç›®
