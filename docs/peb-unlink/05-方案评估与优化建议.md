# PEB Unlink 方案评估与优化建议（工程与合规版）

> 日期：2026-02-18  
> 评估范围：`docs/peb-unlink/` 全部文档  
> 结论导向：提升稳定性、可测试性、可追溯性与合规性

---

## 1. 需求审核（Code Prompt Coach）

### 1.1 清晰性
- 目标清晰：围绕 PEB Unlink 的设计、实现、测试与交付，文档链路完整。

### 1.2 具体性
- 已给出目录结构、代码模板、构建命令与测试清单，执行入口明确。

### 1.3 上下文
- 与项目上下文存在部分偏差：当前仓库强调 x86 与协议统一维护，但该方案对版本兼容与回滚策略描述不足。

### 1.4 结构与格式
- 文档分层合理（总览/快速开始/清单/模板），但存在重复与冲突项，影响落地一致性。

---

## 2. 总体评估结论

当前方案“可读性高，但工程风险偏高”。

- 优点：
  - 交付物边界清楚，执行路径完整。
  - 有阶段划分与验收意识。

- 主要问题：
  - 在 `DllMain` 里放置较重逻辑，稳定性风险高。
  - 使用未文档化内部结构的模板化实现，跨版本脆弱。
  - 测试以人工验证为主，自动化与回归门禁不足。
  - “成功标准”偏功能结果，缺少“失败可恢复、异常可观测、回滚可执行”标准。

---

## 3. 关键问题（按严重度）

### P0（必须先处理）

1. 高风险初始化时机
- 证据：`DllMain` 直接调用隐藏逻辑（`01-实现方案.md:189`、`02-快速开始.md:45`、`04-代码模板.md:570`）。
- 风险：加载阶段执行复杂操作，易导致死锁/崩溃/不可预期行为。
- 优化：将复杂逻辑迁移到受控初始化流程；`DllMain` 仅做最小初始化与调度。

2. 内部结构强耦合
- 证据：模板中直接定义并使用内部结构（`04-代码模板.md:124`、`04-代码模板.md:146`）。
- 风险：系统版本变化后可能发生结构偏移失配，引发稳定性问题。
- 优化：收敛为“受支持接口优先”的实现策略，内部结构访问必须增加版本闸门与失败降级。

3. 失败恢复策略缺失
- 证据：强调“失败继续运行”，但缺少一致回滚机制（`01-实现方案.md:324`）。
- 风险：部分执行后失败会造成状态不一致，后续行为不可预测。
- 优化：补充“事务化步骤 + 回滚点 + 幂等保护 + 状态机”。

### P1（应尽快处理）

1. 测试自动化不足
- 证据：大量人工工具验证（`02-快速开始.md:123`、`03-开发清单.md:157`）。
- 风险：回归成本高，结果不可重复。
- 优化：补齐自动化测试（单元/集成/回归），将关键场景纳入 CI。

2. 成功标准不完整
- 证据：成功标准偏“是否可见”（`00-index.md:97`、`02-快速开始.md:348`）。
- 风险：忽略性能、稳定性、故障恢复等工程指标。
- 优化：新增 SLO 指标：崩溃率、初始化耗时、异常率、回滚成功率。

3. 文档存在重复与范围膨胀
- 证据：快速开始与实现方案重复较多；后续建议扩展到更高风险能力（`02-快速开始.md:300`、`03-开发清单.md:317`）。
- 风险：执行分歧，维护成本高，合规风险上升。
- 优化：删减重复内容，统一“单一事实来源（SSOT）”。

### P2（可排期优化）

1. 时间估算偏乐观
- 证据：9-14 小时覆盖设计到跨版本验证（`00-index.md:88`、`03-开发清单.md:390`）。
- 优化：按“开发/联调/回归/发布”拆分工时，并预留风险缓冲。

2. 版本范围不一致
- 证据：同时提及 XP/7/10/11（`01-实现方案.md:390`、`03-开发清单.md:291`）。
- 优化：按项目真实支持矩阵明确“必须支持/可选支持/不支持”。

---

## 4. 优化后的执行方案（建议替换原 5 天计划）

## Phase A：合规与边界先行（0.5 天）
- 明确用途边界、授权范围、测试环境隔离要求。
- 设定默认关闭策略：编译开关 + 运行时开关双闸门。
- 确定回滚策略：任一关键步骤失败即中止并恢复。

## Phase B：稳定性实现（1.5 天）
- 重构初始化路径：移出高风险时机，采用受控入口执行。
- 引入状态机：`未初始化 -> 初始化中 -> 生效 -> 回滚中 -> 已回滚`。
- 增加幂等保护：重复调用不产生副作用。

## Phase C：验证与发布门禁（1.5 天）
- 自动化测试：
  - 单元测试：参数校验、状态机转换、幂等性。
  - 集成测试：注入后主功能回归。
  - 异常测试：中途失败、重复执行、卸载场景。
- 设立发布门禁：
  - 构建成功 + 核心测试通过 + 日志审计通过。

## Phase D：文档收敛（0.5 天）
- 将重复内容归并到“实现方案”主文档。
- 快速开始只保留最小步骤与跳转链接。
- 在 `docs/项目合并文档.md` 记录关键决策与变更原因。

---

## 5. 文档级改造建议

1. `01-实现方案.md`
- 增加“失败回滚设计”“状态机设计”“发布门禁”章节。
- 删除与快速开始重复的大段操作步骤。

2. `02-快速开始.md`
- 保留最小可执行步骤。
- 去除高风险扩展建议，避免范围蔓延。

3. `03-开发清单.md`
- 用“里程碑门禁”替代“按天堆任务”。
- 每个里程碑增加“退出条件/回滚条件”。

4. `04-代码模板.md`
- 标注“示例性质，不作为跨版本稳定实现依据”。
- 增加错误码规范、日志规范、幂等保护模板。

5. `00-index.md`
- 增加“合规说明与风险提示”入口。

---

## 6. 更新后的验收标准（建议）

- 功能性：核心业务功能无回归。
- 稳定性：长稳测试期间无崩溃、无死锁。
- 可恢复性：任一关键步骤失败可回滚至一致状态。
- 可观测性：关键路径均有结构化日志与错误码。
- 可测试性：自动化测试覆盖关键路径并接入 CI。
- 可追溯性：关键决策记录到 `docs/项目合并文档.md`。

---

## 7. 结语

该目录文档具备良好执行基础，但当前版本更偏“功能导向”，缺少“工程化闭环”。
建议优先完成 P0/P1 项后再推进后续开发，以降低稳定性与维护风险。
