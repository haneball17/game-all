# PEB Unlink 开发检查清单

> **5天开发计划 - 详细任务分解与进度跟踪**

---

## 📅 Day 1: 基础框架搭建

### 上午 (2-3小时)

#### 1.1 创建目录结构
- [ ] 进入 `Payload/modules` 目录
- [ ] 创建 `stealth` 子目录
- [ ] 验证目录结构正确

#### 1.2 创建头文件框架
- [ ] 创建 `peb_utils.h`
  - [ ] 定义命名空间 `stealth`
  - [ ] 定义PEB相关结构体
  - [ ] 声明PEBUtils类
  - [ ] 添加方法注释
  
- [ ] 创建 `module_hider.h`
  - [ ] 声明ModuleHider类
  - [ ] 定义接口方法
  - [ ] 添加错误处理机制

#### 1.3 更新项目配置
- [ ] 编辑 `Payload.vcxproj`
  - [ ] 添加4个新文件到项目
  - [ ] 添加预处理器定义 `ENABLE_STEALTH_MODE=1`
  - [ ] 验证XML格式正确
- [ ] 重新加载项目
- [ ] 尝试编译（预期会有未实现的方法错误）

### 下午 (3-4小时)

#### 1.4 实现PEB访问功能
- [ ] 创建 `peb_utils.cpp`
  - [ ] 实现 `GetCurrentPEB()`
    - [ ] 测试x86方法 (`__readfsdword`)
    - [ ] 添加调试输出
    - [ ] 验证返回值非空
  - [ ] 实现 `GetLdrData()`
    - [ ] 添加空指针检查
    - [ ] 验证LDR已初始化
  - [ ] 实现 `EnumModules()`
    - [ ] 遍历InLoadOrderModuleList
    - [ ] 添加计数统计
    - [ ] 实现回调机制
  - [ ] 实现 `FindModuleByName()`
    - [ ] 使用不区分大小写比较
    - [ ] 测试查找kernel32.dll
  - [ ] 实现 `FindModuleByBaseAddress()`
    - [ ] 测试查找ntdll.dll
  - [ ] 实现 `GetCurrentModuleBase()`
    - [ ] 验证返回值正确

#### 1.5 单元测试
- [ ] 创建测试函数 `test_peb_utils()`
  - [ ] 测试PEB获取
  - [ ] 测试模块枚举
  - [ ] 测试模块查找
  - [ ] 输出所有找到的模块
- [ ] 编译测试
- [ ] 运行测试
- [ ] 验证输出正确

#### 1.6 编译通过
- [ ] 解决所有编译错误
- [ ] 解决所有警告
- [ ] 确认输出文件生成

**Day 1 完成标准**: 代码编译通过，能正确遍历模块列表

---

## 📅 Day 2: Unlink核心实现

### 上午 (3-4小时)

#### 2.1 实现ModuleHider基础功能
- [ ] 创建 `module_hider.cpp`
  - [ ] 实现错误信息存储
  - [ ] 实现 `GetLastErrorMsg()`
  - [ ] 实现 `HideCurrentModule()`
    - [ ] 获取当前模块基地址
    - [ ] 调用HideModuleByBaseAddress
  - [ ] 实现 `HideModuleByName()`
    - [ ] 参数验证
    - [ ] 调用PEBUtils查找
    - [ ] 错误处理
  - [ ] 实现 `HideModuleByBaseAddress()`
    - [ ] 参数验证
    - [ ] 查找模块
    - [ ] 错误处理

#### 2.2 实现ValidateLinks()
- [ ] 验证InLoadOrderLinks
  - [ ] 检查Flink->Blink
  - [ ] 检查Blink->Flink
- [ ] 验证InMemoryOrderLinks
  - [ ] 同上
- [ ] 验证InInitializationOrderLinks
  - [ ] 同上
- [ ] 添加调试输出

### 下午 (3-4小时)

#### 2.3 实现UnlinkModule()核心逻辑
- [ ] 保存原始指针
  - [ ] 保存Flink[3]
  - [ ] 保存Blink[3]
- [ ] 打印模块信息
  - [ ] 基地址
  - [ ] 模块大小
  - [ ] 模块名
  - [ ] 完整路径
- [ ] Unlink InLoadOrderLinks
  - [ ] 修改Blink->Flink
  - [ ] 修改Flink->Blink
  - [ ] 添加日志
- [ ] Unlink InMemoryOrderLinks
  - [ ] 同上
- [ ] Unlink InInitializationOrderLinks
  - [ ] 同上

#### 2.4 验证Unlink结果
- [ ] 重新查找模块
- [ ] 检查是否仍在链表中
- [ ] 返回成功/失败
- [ ] 设置错误信息

#### 2.5 集成测试
- [ ] 在Helper模块中添加调用
  - [ ] 包含头文件
  - [ ] 在DllMain中调用
  - [ ] 添加条件编译
- [ ] 编译Payload
- [ ] 编译Injector
- [ ] 注入到notepad.exe测试

#### 2.6 初步验证
- [ ] 注入成功
- [ ] 进程不崩溃
- [ ] 查看调试输出
- [ ] 验证"Successfully hidden"消息

**Day 2 完成标准**: Unlink逻辑实现，注入后进程稳定

---

## 📅 Day 3: 完整测试与验证

### 上午 (2-3小时)

#### 3.1 工具验证
- [ ] 使用Process Hacker验证
  - [ ] 打开Process Hacker
  - [ ] 查找目标进程
  - [ ] 查看模块列表
  - [ ] 确认game-payload.dll不可见
  - [ ] 截图保存
- [ ] 使用Process Explorer验证
  - [ ] 同上流程
  - [ ] 确认一致性
  - [ ] 截图保存

#### 3.2 API验证
- [ ] 创建test_enumeration.cpp
  - [ ] 实现IsModuleVisible()
  - [ ] 实现IsModuleVisibleEnum()
  - [ ] 添加main()函数
- [ ] 编译测试工具
- [ ] 在注入的进程中运行
- [ ] 验证返回HIDDEN

#### 3.3 WinDbg验证
- [ ] 启动WinDbg
- [ ] 附加到目标进程
- [ ] 运行!peb命令
- [ ] 检查Ldr链表
- [ ] 确认模块不在列表中
- [ ] 保存输出日志

### 下午 (2-3小时)

#### 3.4 功能测试
- [ ] 测试Helper功能
  - [ ] 验证所有功能正常
  - [ ] 测试热更新
  - [ ] 测试热键
- [ ] 测试Sync功能
  - [ ] 验证输入同步
  - [ ] 测试配置加载
- [ ] 长时间运行测试
  - [ ] 运行30分钟
  - [ ] 观察稳定性
  - [ ] 检查内存泄漏

#### 3.5 Minidump测试
- [ ] 生成Minidump
  - [ ] 使用MiniDumpWriteDump
  - [ ] 保存dump文件
- [ ] 分析dump
  - [ ] 使用WinDbg打开
  - [ ] 执行lm命令
  - [ ] 确认不包含game-payload.dll
- [ ] 记录结果

#### 3.6 边缘情况测试
- [ ] 重复调用测试
  - [ ] 多次调用HideCurrentModule()
  - [ ] 验证不会崩溃
- [ ] 失败场景测试
  - [ ] 尝试隐藏不存在的模块
  - [ ] 验证错误处理
- [ ] 卸载测试
  - [ ] FreeLibrary后检查
  - [ ] 验证清理正确

**Day 3 完成标准**: 所有测试通过，模块成功隐藏

---

## 📅 Day 4: 优化与文档

### 上午 (2小时)

#### 4.1 代码优化
- [ ] 性能优化
  - [ ] 减少不必要的遍历
  - [ ] 优化字符串比较
- [ ] 代码清理
  - [ ] 删除调试代码
  - [ ] 统一注释风格
  - [ ] 添加缺失的注释
- [ ] 错误处理完善
  - [ ] 添加更多边界检查
  - [ ] 改进错误信息

### 下午 (2-3小时)

#### 4.2 文档编写
- [ ] 编写README.md
  - [ ] 功能说明
  - [ ] 使用方法
  - [ ] API文档
- [ ] 编写实现文档
  - [ ] 架构说明
  - [ ] 关键算法
  - [ ] 注意事项
- [ ] 更新项目主文档
  - [ ] 添加stealth模块说明
  - [ ] 更新编译指南

#### 4.3 配置优化
- [ ] 添加运行时开关
  - [ ] 在共享内存中添加配置
  - [ ] GUI中添加控制选项
- [ ] 编译选项优化
  - [ ] Debug/Release配置
  - [ ] 条件编译优化
- [ ] 版本管理
  - [ ] 添加版本号
  - [ ] 更新ChangeLog

#### 4.4 演示准备
- [ ] 准备演示视频
  - [ ] 录制注入过程
  - [ ] 展示Process Hacker验证
  - [ ] 展示Minidump分析
- [ ] 准备对比图表
  - [ ] 隐藏前/后对比
  - [ ] 性能对比
  - [ ] 检测难度对比

**Day 4 完成标准**: 代码优化完成，文档齐全

---

## 📅 Day 5: 收尾与总结

### 上午 (1-2小时)

#### 5.1 最终测试
- [ ] 完整回归测试
  - [ ] 所有Day 3测试重做
  - [ ] 确认无回归问题
- [ ] 跨版本测试
  - [ ] Windows 7测试（如可能）
  - [ ] Windows 10测试
  - [ ] Windows 11测试
- [ ] 压力测试
  - [ ] 100次注入/卸载循环
  - [ ] 10个进程并发注入

### 下午 (1-2小时)

#### 5.2 代码审查
- [ ] 自我审查
  - [ ] 检查代码风格
  - [ ] 检查潜在bug
  - [ ] 检查安全问题
- [ ] 性能分析
  - [ ] 测试Unlink耗时
  - [ ] 检查内存占用
  - [ ] 验证无内存泄漏

#### 5.3 总结与规划
- [ ] 编写总结报告
  - [ ] 实现的功能
  - [ ] 测试结果
  - [ ] 遇到的问题
  - [ ] 解决方案
- [ ] 下一步规划
  - [ ] Manual Map计划
  - [ ] 其他增强功能
  - [ ] 时间估算

**Day 5 完成标准**: 所有工作完成，准备发布

---

## ✅ 最终验收清单

### 功能完整性
- [ ] PEB Unlink实现
- [ ] Helper模块集成
- [ ] Sync模块集成
- [ ] 配置开关
- [ ] 错误处理

### 质量标准
- [ ] 编译无警告
- [ ] 运行无崩溃
- [ ] 功能正常
- [ ] 代码注释完整
- [ ] 文档齐全

### 隐蔽效果
- [ ] Process Hacker看不到
- [ ] Process Explorer看不到
- [ ] CreateToolhelp32Snapshot看不到
- [ ] EnumProcessModules看不到
- [ ] Minidump不记录

### 测试覆盖
- [ ] 单元测试
- [ ] 集成测试
- [ ] 功能测试
- [ ] 压力测试
- [ ] 边缘测试

### 交付物
- [ ] 源代码
- [ ] 编译配置
- [ ] 使用文档
- [ ] 测试报告
- [ ] 演示视频

---

## 🎯 关键里程碑

```
M1 (Day 1 上午):   框架搭建完成
M2 (Day 1 下午):   PEB访问功能实现
M3 (Day 2 上午):   Unlink核心实现
M4 (Day 2 下午):   基本集成完成
M5 (Day 3):        全部测试通过
M6 (Day 4):        文档完善
M7 (Day 5):        最终验收
```

---

## 📊 进度跟踪表

| 任务 | 预计时间 | 实际时间 | 完成度 | 备注 |
|------|---------|---------|--------|------|
| Day 1 上午 | 2-3h | ___h | __% | |
| Day 1 下午 | 3-4h | ___h | __% | |
| Day 2 上午 | 3-4h | ___h | __% | |
| Day 2 下午 | 3-4h | ___h | __% | |
| Day 3 上午 | 2-3h | ___h | __% | |
| Day 3 下午 | 2-3h | ___h | __% | |
| Day 4 | 4-5h | ___h | __% | |
| Day 5 | 2-4h | ___h | __% | |
| **总计** | **9-14h** | ___h | __% | |

---

## 🚨 风险管理

### 潜在风险

| 风险 | 概率 | 影响 | 应对策略 |
|------|------|------|----------|
| 结构体定义错误 | 中 | 高 | 参考官方文档，充分测试 |
| Unlink导致崩溃 | 中 | 高 | 添加验证，逐步调试 |
| 模块仍可见 | 低 | 中 | 检查所有3个链表 |
| 影响DLL功能 | 低 | 高 | 失败时回退，保证功能 |
| 平台兼容性 | 中 | 中 | 先专注x86，预留x64 |

### 应急预案

```
如果Day 2结束Unlink仍失败:
→ 暂停，回退代码
→ 详细分析问题
→ 调整策略

如果Day 3测试失败:
→ 标记为已知问题
→ 记录详细日志
→ 寻求外部帮助

如果影响现有功能:
→ 立即回退
→ 修复后重新集成
→ 增加测试
```

---

祝开发顺利！💪
