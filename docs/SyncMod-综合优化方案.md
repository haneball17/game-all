# SyncMod 综合优化方案（性能 + 稳定性）

> 范围：仅方案落地文档，不直接改代码。  
> 目标：解决“切窗无输入、同步断续、连发器不连续”并提升 SyncMod 性能与稳定性。  
> 顺序：按风险低→收益高排序实施。

---

## 一、总体结论

1. 当前 UI 卡死问题已显著缓解（EnumWindows 已移出 Hook）。  
2. 仍存在三个现象：  
   - 切换窗口后短时间无法输入  
   - 同步偶发断续（按住方向键只走一段）  
   - 连发器 X 键从窗口只按一次  
3. 主要根因集中在：  
   - **共享心跳超时过短**  
   - **前台判断空档/自动暂停清键**  
   - **连发边沿未同步**  
   - **Hook 内日志与共享内存读取过重**

---

## 二、实施顺序（推荐）

1. **提高共享内存存活超时**（直接缓解断续）  
2. **切窗 Grace + 高频前台检测**（缓解切窗无输入）  
3. **连发键边沿合成**（解决连发器只按一次）  
4. **性能优化**（快照缓存 + 日志降频）

---

## 三、方案细化

### 1) 共享心跳超时提升（优先级最高）

**现象关联**  
按住方向键“走一段就停”，与 `IsSnapshotAlive` 判定失效高度相关。  

**根因**  
`kSharedTimeoutMs = 200` 过短，UI/GC 抖动或心跳轻微迟滞即被判定失联，导致强制抬起按键。  

**方案**  
- 将超时提高到 **500~1000ms**  
- 或改成环境变量配置（如 `DNFSYNC_HEARTBEAT_TIMEOUT_MS`），便于现场调参  

**修改位置**  
`Payload/modules/sync/SyncMod.cpp`  
- `kSharedTimeoutMs` 常量  

**预期效果**  
同步连续性显著提升，方向键长按不再中断。

---

### 2) 切窗 Grace + 高频前台检测

**现象关联**  
切换窗口后短时间无法输入。  

**根因**  
`SyncController` 每秒刷新窗口快照，切换时会有 0~1 秒的前台判定空档；  
`ForegroundIsDnf=false → activePid=0 → ShouldSpoofFocus=false`，导致后台伪造关闭。  
同时自动暂停触发 `ClearStuckKeys`，进一步造成“输入空窗”。  

**方案**  
1. **高频前台检测**（100~200ms）  
2. **Grace 时间**（如 800ms）：短时间内仍沿用上一次前台 PID  

**修改位置**  
`GUI/Modules/Sync/Core/SyncController.cs`  
- 新增前台快速检测计时器  
- 引入 `foreground_grace_ms` 的逻辑  

**预期效果**  
切窗后的“无输入空档”大幅减少甚至消失。

---

### 3) 连发器按键边沿合成

**现象关联**  
主窗口 X 连发正常，从窗口只按一次。  

**根因**  
连发器产生的快速按下/抬起边沿未进入共享内存；  
从窗口仅同步“按键状态”，因此只触发一次。  

**方案**  
在 Sync 侧加入“连发合成逻辑”：  
- 新增配置：`repeat_keys`、`repeat_interval_ms`  
- 当检测到主窗口持续按下时，定时合成 `down/up` 边沿  

**修改位置**  
`GUI/Modules/Sync/Core/KeyStateTracker.cs`  
`GUI/Modules/Sync/Core/KeyboardProfile.cs`  
`GUI/Modules/Sync/Core/SyncController.cs`  

**预期效果**  
从窗口与主窗口保持一致连点效果。

---

### 4) 性能优化（降低 Hook 压力）

**现象关联**  
高频 Hook 路径可能引发性能抖动，间接影响心跳与输入。  

**方案**  
1. **共享内存快照缓存**  
   - `ReadSharedSnapshot` 做 2~5ms 缓存  
2. **RawInput 日志采样/关闭**  
   - 用环境变量控制日志  
   - 每秒限量输出  

**修改位置**  
`Payload/modules/sync/SyncMod.cpp`  

**预期效果**  
降低 CPU 与 IO 压力，提升稳定性。

---

## 四、验收标准

1. 多实例启动后，后台输入持续稳定，无明显断续  
2. 切换窗口后输入延迟显著降低（<= 200ms）  
3. 连发器 X 键主从窗口效果一致  
4. 日志量与 CPU 占用明显下降

---

## 五、实施说明

按顺序逐步实施，每一步完成后分别做验证，避免多项改动混合导致定位困难。

